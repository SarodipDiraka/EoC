"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[66],{5066:function(e,t,s){s.r(t),s.d(t,{default:function(){return ew}});var i=s(5893),n=s(7294),a=s(2260),o=s.n(a);let r=Object.freeze({ENEMY_INIT:"ENEMY_INIT",ENEMY_DESTROYED:"ENEMY_DESTROYED",ENEMY_HIT:"ENEMY_HIT",PLAYER_SPAWN:"PLAYER_SPAWN",PLAYER_DESTROYED:"PLAYER_DESTROYED",GAME_OVER:"GAME_OVER",SHIP_HIT:"SHIP_HIT",SHIP_SHOOT:"SHIP_SHOOT",START_GAME:"start-game",RESTART_GAME:"restart-game",CONTINUE_GAME:"continue-game",CLEANUP_GAME:"cleanup-game",WEAPON_POWER_CHANGED:"WEAPON_POWER_CHANGED",WEAPON_CHANGED:"WEAPON_CHANGED",PLAYER_BOMB_ACTIVATED:"player-bomb-activated",PLAYER_BOMB_DAMAGE_TICK:"player-bomb-damage-tick",BOMB_COUNT_CHANGED:"bomb-count-changed",POWER_CHANGED:"power-changed",SETTINGS_CHANGED:"SETTINGS_CHANGED",MAIM_MENU_FROM_GAME_OVER:"main-menu-from-game-over",ADD_POWER:"add-power",ADD_SCORE:"add-score",ADD_BOMB:"add-bomb",ADD_LIFE:"add-life",START_SPAWNER:"start-spawner",STOP_ALL_SPAWNERS:"stop-all-spawners",RESET_ALL_SPAWNERS:"reset-all-spawners",SPAWN_BOSS:"spawn-boss",LEVEL_COMPLETE:"level-complete",GAME_COMPLETE:"game-complete",PLAYER_READY:"player-ready",PAUSE_GAME:"pause-game",RESUME_GAME:"resume-game",ADD_BONUS_SCORE:"add-bonus-score",BOSS_DEFEATED:"boss-defeated",BOSS_SPAWNED:"BOSS_SPAWNED",BOSS_INIT:"BOSS_INIT",BOSS_PHASE_CHANGE:"BOSS_PHASE_CHANGE",BOSS_HEALTH_CHANGE:"BOSS_HEALTH_CHANGE"});class h extends a.Events.EventEmitter{constructor(){super(),Object.assign(this,r)}}let l=new h;var c=s(657);class u extends o().Scene{preload(){this.load.json("animations_json",(0,c.A)("data/animations.json")),this.createProgressBar()}create(){l.emit("current-scene-ready",this),this.scene.start("PreloadScene")}createProgressBar(){let{width:e,height:t}=this.cameras.main,s=this.add.graphics(),i=this.add.graphics();i.fillStyle(2236962,.8),i.fillRect(e/4,t/2-30,e/2,50),this.load.on("progress",i=>{s.clear(),s.fillStyle(16777215,1),s.fillRect(e/4+10,t/2-20,(e/2-20)*i,30)})}constructor(){super({key:"BootScene"})}}class d{collideWithEnemyShip(){this.healthComponent.isDead||this.healthComponent.die()}collideWithEnemyProjectile(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.healthComponent.isDead||(this.healthComponent.hit(e),this.eventBusComponent.emit(r.SHIP_HIT))}constructor(e,t){this.healthComponent=e,this.eventBusComponent=t}}class p{get life(){return this.currentLife}get isDead(){return this.isDeadFlag}setLife(e){this.currentLife=e}reset(){this.currentLife=this.startingLife,this.isDeadFlag=!1}hit(e){!this.isDeadFlag&&(this.currentLife=this.currentLife-e,this.currentLife<=0&&(this.isDeadFlag=!0))}die(){this.isDeadFlag||(this.currentLife=0,this.isDeadFlag=!0)}constructor(e){this.startingLife=e,this.currentLife=e,this.isDeadFlag=!1}}class m{get upIsDown(){return this._up}get downIsDown(){return this._down}get leftIsDown(){return this._left}get rightIsDown(){return this._right}get focusIsDown(){return this._focus}get primaryActionIsDown(){return this._primaryAction}get secondaryActionIsDown(){return this._secondaryAction}get thirdActionIsDown(){return this._thirdAction}pressUp(){this._up=!0}pressDown(){this._down=!0}pressLeft(){this._left=!0}pressRight(){this._right=!0}pressFocus(){this._focus=!0}pressPrimaryAction(){this._primaryAction=!0}pressSecondaryAction(){this._secondaryAction=!0}pressThirdAction(){this._thirdAction=!0}releaseUp(){this._up=!1}releaseDown(){this._down=!1}releaseLeft(){this._left=!1}releaseRight(){this._right=!1}releaseFocus(){this._focus=!1}releasePrimaryAction(){this._primaryAction=!1}releaseSecondaryAction(){this._secondaryAction=!1}releaseThirdAction(){this._thirdAction=!1}reset(){this._up=!1,this._down=!1,this._left=!1,this._right=!1,this._focus=!1,this._primaryAction=!1,this._secondaryAction=!1,this._thirdAction=!1}constructor(){this._primaryAction=!1,this._secondaryAction=!1,this._thirdAction=!1,this.reset()}}class f extends m{set lockInput(e){this.inputLocked=e}update(){if(this.inputLocked){this.reset();return}this.cursorKeys.up.isDown?this.pressUp():this.releaseUp(),this.cursorKeys.down.isDown?this.pressDown():this.releaseDown(),this.cursorKeys.left.isDown?this.pressLeft():this.releaseLeft(),this.cursorKeys.right.isDown?this.pressRight():this.releaseRight(),this.cursorKeys.space.isDown||this.shootKeyZ.isDown?this.pressPrimaryAction():this.releasePrimaryAction(),this.shootKeyX.isDown?this.pressSecondaryAction():this.releaseSecondaryAction(),this.shootKeyC.isDown?this.pressThirdAction():this.releaseThirdAction(),this.focusKeyShift.isDown?this.pressFocus():this.releaseFocus()}constructor(e){super(),this.cursorKeys=e.input.keyboard.createCursorKeys(),this.shootKeyZ=e.input.keyboard.addKey(o().Input.Keyboard.KeyCodes.Z),this.shootKeyX=e.input.keyboard.addKey(o().Input.Keyboard.KeyCodes.X),this.shootKeyC=e.input.keyboard.addKey(o().Input.Keyboard.KeyCodes.C),this.focusKeyShift=e.input.keyboard.addKey(o().Input.Keyboard.KeyCodes.SHIFT),this.inputLocked=!1}}class g{reset(){this.gameObject.body&&this.gameObject.body.setVelocityX(0)}update(){if(!this.gameObject.body)return;let e=this.gameObject.body,t=this.inputComponent.focusIsDown?.5:1,s=(this.inputComponent.upIsDown||this.inputComponent.downIsDown)&&(this.inputComponent.leftIsDown||this.inputComponent.rightIsDown),i=this.velocity*(s?.707:1)*t;this.inputComponent.leftIsDown?e.setVelocityX(-i):this.inputComponent.rightIsDown?e.setVelocityX(i):e.setVelocityX(0)}constructor(e,t,s){if(this.gameObject=e,this.inputComponent=t,this.velocity=s,!this.gameObject.body)throw Error("GameObject must have Arcade Physics body enabled")}}class y{reset(){this.gameObject.body&&this.gameObject.body.setVelocityY(0)}update(){if(!this.gameObject.body)return;let e=this.gameObject.body,t=this.inputComponent.focusIsDown?.5:1,s=(this.inputComponent.leftIsDown||this.inputComponent.rightIsDown)&&(this.inputComponent.upIsDown||this.inputComponent.downIsDown),i=this.velocity*(s?.707:1)*t;this.inputComponent.downIsDown?e.setVelocityY(i):this.inputComponent.upIsDown?e.setVelocityY(-i):e.setVelocityY(0)}constructor(e,t,s){if(!e.body)throw Error("GameObject must have Arcade Physics body enabled");this.gameObject=e,this.inputComponent=t,this.velocity=s}}let v=[{waves:[{duration:2e4,delayAfter:4e3,spawners:[{enemyType:"scout",interval:200,groupSize:1,patternType:"random",patternParams:{type:"random",params:{minX:30,maxX:450,minY:-50,maxY:-20}}}]},{duration:18e3,delayAfter:1e3,spawners:[{enemyType:"fighter",interval:6e3,groupSize:8,count:16,patternType:"line",patternParams:{type:"line",params:{startX:30,startY:-20,stepX:60,stepY:0}}}]},{duration:3e4,delayAfter:5e3,spawners:[{enemyType:"circular_fighter",interval:1e5,groupSize:8,count:8,patternType:"circle",patternParams:{type:"circle",params:{centerX:240,centerY:340,radius:300,fullCircle:!0}}}]}],boss:{enemyType:"firstBoss"}},{waves:[{duration:4e4,delayAfter:4e3,initialDelay:8e3,spawners:[{enemyType:"scout",interval:1e4,groupSize:20,patternType:"spiral",patternParams:{type:"spiral",params:{centerX:250,centerY:-100,radiusStep:15,angleStep:.3}}}]},{duration:2e4,delayAfter:4e3,spawners:[{enemyType:"scout",interval:3e3,groupSize:20,patternType:"wave",patternParams:{type:"wave",params:{startX:50,startY:-50,amplitude:100,wavelength:60,direction:"horizontal"}}}]},{duration:5e3,delayAfter:4e3,spawners:[{enemyType:"fighter",interval:2e3,groupSize:3,count:3,patternType:"direct",patternParams:{type:"direct",params:{positions:[{x:100,y:-50},{x:200,y:-50},{x:300,y:-50}]}}}]}],boss:{enemyType:"firstBoss"}}],S={base:{speed:600,lifespan:1e3,texture:"bullet",scale:.8,size:{width:14,height:18},damage:20},powerLevels:{0:{bulletCount:3,spread:15,fireRate:300,yOffset:-20},1:{bulletCount:5,spread:25,fireRate:250,yOffset:-20},2:{bulletCount:7,spread:35,fireRate:200,yOffset:-20},3:{bulletCount:9,spread:45,fireRate:150,yOffset:-20}},laser:{damageLevels:[1,2,3,4],widthLevels:[16,22,26,30],fireRate:50,colors:{inner:65535,outer:26367,glow:43775},alpha:.8},homing:{primary:{bulletCount:[2,2,3,3],spread:[2,2,15,15],fireRate:300,yOffset:-20,damage:5},homing:{bulletCount:[2,4,6,8],texture:"rocket",speed:300,turnRate:.08,delayBeforeHoming:100,lifespan:5e3,damage:7}}},I={count:3,duration:5e3,damageInterval:50,damage:5,cooldown:1e3},w="game_settings",_="game_highscores";class b{static loadSettings(){let e=this.getDefaultConfig();try{let t=localStorage.getItem(w);return t?{...e,...JSON.parse(t)}:e}catch(t){return console.error("Failed to load settings",t),e}}static getDefaultConfig(){return{musicVolume:.5,sfxVolume:.1,showFPS:!0,weaponType:"wide"}}static saveSettings(e){try{localStorage.setItem(w,JSON.stringify(e))}catch(e){console.error("Failed to save settings",e)}}static loadHighScores(){let e=Array(10).fill(null).map((e,t)=>({name:"NoEntry",score:(10-t)*1e3,level:10-t>=3?"All":10-t,date:new Date(Date.now()-864e5*t).toISOString()}));try{let t=localStorage.getItem(_);return t?JSON.parse(t):e}catch(t){return console.error("Failed to load highscores",t),e}}static saveHighScores(e){try{let t=[...e].sort((e,t)=>t.score-e.score).slice(0,10);localStorage.setItem(_,JSON.stringify(t))}catch(e){console.error("Failed to save highscores",e)}}static addHighScore(e){let t=[...this.loadHighScores(),{...e,date:new Date().toISOString()}].sort((e,t)=>t.score-e.score).slice(0,10);return this.saveHighScores(t),t}static isScoreInTop(e){let t=this.loadHighScores();return t.length<10||e>t[t.length-1].score}}class E{mapWeaponType(e){switch(e){case"wide":return 1;case"laser":return 2;case"rockets":return 3}}update(e){this.fireTimer-=e,2===this.weaponType&&this.inputComponent.primaryActionIsDown?this.updateLaser():(this.laserActive||!this.inputComponent.primaryActionIsDown)&&this.deactivateLaser(),this.fireTimer<=0&&this.inputComponent.primaryActionIsDown&&(this.fire(),this.fireTimer=this.getFireRate())}activateLaser(){if(!this.laserBeam||!this.gameObject.active)return;let e=this.getPowerLevel();this.laserDamagePerTick=S.laser.damageLevels[e],this.laserWidth=S.laser.widthLevels[e],this.laserActive=!0,this.laserBeam.setVisible(!0),this.eventBusComponent.emit(r.SHIP_SHOOT)}deactivateLaser(){var e;this.laserBeam&&(this.laserActive=!1,this.laserBeam.clear(),null===(e=this.laserGlow)||void 0===e||e.clear(),this.laserBeam.setVisible(!1))}updateLaser(){if(!this.laserActive||!this.laserBeam||!this.gameObject.active)return;let e=this.getPowerLevel();this.laserDamagePerTick=S.laser.damageLevels[e],this.laserWidth=S.laser.widthLevels[e],this.drawLaser()}drawLaser(){if(!this.laserBeam||!this.laserGlow)return;let e=S.laser,t=this.gameObject.x,s=this.gameObject.y-20,i=this.gameObject.scene.cameras.main.height,n=this.laserWidth/2,a=this.gameObject.scene.time.now;this.laserBeam.clear(),this.laserGlow.clear();let r=.3+.1*Math.sin(.005*a);this.laserGlow.fillStyle(e.colors.glow,r),this.laserGlow.fillRect(t-1.8*n,s,1.8*this.laserWidth,-i),this.laserGlow.fillStyle(e.colors.glow,.7*r),this.laserGlow.fillRect(t-1.4*n,s,1.4*this.laserWidth,-i),this.laserGlow.fillStyle(e.colors.glow,.4*r),this.laserGlow.fillRect(t-n,s,this.laserWidth,-i);let h=o().Display.Color.ValueToColor(65535),l=o().Display.Color.ValueToColor(26367);for(let e=0;e<10;e++){let n=e/9,a=o().Display.Color.Interpolate.ColorWithColor(l,h,10,e),r=this.laserWidth*(1-.6*n),c=.3+.7*(1-n);this.laserBeam.fillStyle(o().Display.Color.GetColor(a.r,a.g,a.b),c),this.laserBeam.fillRect(t-r/2,s,r,-i)}let c=.4*this.laserWidth,u=.9+.1*Math.sin(.01*a),d=Math.ceil(i/20);for(let i=0;i<d;i++){let n=s-20*i,o=u*(.8+.2*Math.sin(.02*a+.5*i));this.laserBeam.fillStyle(e.colors.inner,o),this.laserBeam.fillRect(t-c/2,n,c,-20)}this.laserBeam.fillStyle(16777215,.6*(.5+.5*Math.sin(.03*a))),this.laserBeam.fillRect(t-n-2,s,4,-i*(.7+.3*Math.sin(.02*a))),this.laserBeam.fillRect(t+n-2,s,4,-i*(.7+.3*Math.sin(.025*a))),this.laserHitArea.setTo(t-n,0,this.laserWidth,s)}isLaserActive(){return this.laserActive}fire(){switch(this.weaponType){case 1:this.fireWideWeapon();break;case 2:this.laserActive||this.activateLaser();break;case 3:this.fireHomingWeapon()}}fireWideWeapon(){let e=this.getCurrentPattern(),t=this.gameObject.x,s=this.gameObject.y+e.yOffset,i=this.calculateSpreadAngles(e.bulletCount,e.spread);for(let n=0;n<e.bulletCount;n++){let e=this.bulletGroup.getFirstDead(!1);if(!e)continue;let a=i[n],r=o().Math.DegToRad(a);this.setupBullet(e,t,s,r)}this.eventBusComponent.emit(r.SHIP_SHOOT)}calculateSpreadAngles(e,t){if(1===e)return[0];let s=[],i=2*t/(e-1);for(let n=0;n<e;n++)s.push(-t+n*i);return s}fireHomingWeapon(){let e=this.getPowerLevel(),t=S.homing.primary,s=S.homing.homing;this.firePrimaryHomingBullets(e,t),this.fireHomingBullets(e,s)}firePrimaryHomingBullets(e,t){let s=t.bulletCount[e],i=t.spread[e],n=this.calculateSpreadAngles(s,i);for(let e=0;e<s;e++){let s=this.bulletGroup.getFirstDead(!1);s&&this.setupBullet(s,this.gameObject.x,this.gameObject.y+t.yOffset,o().Math.DegToRad(n[e]),!1,!0)}}fireHomingBullets(e,t){let s=t.bulletCount[e],i=2*Math.PI/s;for(let e=0;e<s;e++){let s=this.homingBulletGroup.getFirstDead(!1);if(!s)continue;let n=i*e,a=30*Math.cos(n)*o().Math.FloatBetween(.8,1.2),r=15*Math.sin(n)*o().Math.FloatBetween(.8,1.2);this.setupBullet(s,this.gameObject.x+a,this.gameObject.y+r+15,Math.PI+o().Math.FloatBetween(-.2,.2),!0),s.setTexture(t.texture),s.setData("homingData",{delay:t.delayBeforeHoming,turnRate:t.turnRate*o().Math.FloatBetween(.95,1.05),target:null,speed:t.speed*o().Math.FloatBetween(.95,1.05)})}}getHomingBulletGroup(e){var t;return this.isActive&&this.homingBulletGroup&&this.gameObject.scene&&(null===(t=this.homingBulletGroup.scene)||void 0===t?void 0:t.scene)===this.gameObject.scene.scene?this.homingBulletGroup:null}setupBullet(e,t,s,i){var n;let a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(!this.gameObject.scene)return;e.enableBody(!0,t,s,!0,!0),e.setData("lifespan",this.bulletConfig.lifespan),e.setData("damage",a?S.homing.homing.damage:o?this.homingPrimaryConfig.damage:this.bulletConfig.damage),e.setScale(this.bulletConfig.scale),null===(n=e.body)||void 0===n||n.setSize(this.bulletConfig.size.width,this.bulletConfig.size.height),e.setRotation(i);let r=Math.sin(i)*this.bulletConfig.speed,h=-(Math.cos(i)*this.bulletConfig.speed);e.body.setVelocity(r,h)}getFireRate(){switch(this.weaponType){case 1:return this.getCurrentPattern().fireRate;case 2:return 0;case 3:return S.homing.primary.fireRate;default:return 300}}worldStep(e){this.updateBulletsLifespan(this.bulletGroup,e),this.updateBulletsLifespan(this.homingBulletGroup,e)}updateBulletsLifespan(e,t){e.getChildren().forEach(e=>{if(!e.active)return;let s=e.getData("lifespan")-t;e.setData("lifespan",s),s<=0&&e.disableBody(!0,!0)})}destroyBullet(e){e.setData("lifespan",0)}getBulletGroup(){var e;return this.bulletGroup&&this.gameObject.scene&&(null===(e=this.bulletGroup.scene)||void 0===e?void 0:e.scene)===this.gameObject.scene.scene?this.bulletGroup:null}cleanupOffscreenBullets(){this.cleanupGroupOffscreen(this.bulletGroup),this.cleanupGroupOffscreen(this.homingBulletGroup)}cleanupGroupOffscreen(e){let t=this.gameObject.scene.physics.world.bounds;e.getChildren().forEach(e=>{e.active&&(e.y<-60||e.y>t.height+60||e.x<-60||e.x>t.width+60)&&e.disableBody(!0,!0)})}addPower(e){let t=this.getPowerLevel();this.currentPower=o().Math.Clamp(this.currentPower+e,0,this.maxPower);let s=this.getPowerLevel();this.eventBusComponent.emit(r.POWER_CHANGED,this.currentPower),t!==s&&this.eventBusComponent.emit(r.WEAPON_POWER_CHANGED,{oldLevel:t,newLevel:s,homingGroup:this.homingBulletGroup})}getPower(){return this.currentPower}getPowerLevel(){return this.currentPower>=300?3:this.currentPower>=200?2:this.currentPower>=100?1:0}getCurrentPattern(){let e=this.getPowerLevel();return S.powerLevels[e]}setWeaponType(e){if(2===this.weaponType&&this.deactivateLaser(),this.weaponType=e,this.weaponType===e)return}getWeaponType(){return this.weaponType}destroyGroup(e){if(e&&this.gameObject.scene)try{e.getChildren().forEach(e=>{e.body&&this.gameObject.scene.physics.world.disableBody(e.body)}),e.clear(!0,!0),e.scene&&e.destroy()}catch(e){console.warn("Error destroying group:",e)}}cleanup(){var e,t,s;this.isDestroyed||(this.isActive=!1,this.isDestroyed=!0,null===(e=this.laserBeam)||void 0===e||e.destroy(),this.laserBeam=null,null===(t=this.laserGlow)||void 0===t||t.destroy(),this.laserGlow=null,this.gameObject.scene&&this.gameObject.scene.physics.world.off(o().Physics.Arcade.Events.WORLD_STEP,this.worldStep,this),this.destroyGroup(this.bulletGroup),this.destroyGroup(this.homingBulletGroup),null===(s=this.cleanupTimer)||void 0===s||s.destroy())}constructor(e,t,s){this.fireTimer=0,this.currentPower=0,this.maxPower=300,this.isDestroyed=!1,this.laserBeam=null,this.laserActive=!1,this.laserWidth=0,this.laserHitArea=new(o()).Geom.Rectangle,this.laserDamagePerTick=0,this.laserGlow=null,this.isActive=!0,this.gameObject=e,this.inputComponent=t,this.eventBusComponent=s,this.bulletConfig={...S.base},this.homingPrimaryConfig={...S.homing.primary};let i=b.loadSettings();this.weaponType=this.mapWeaponType(i.weaponType),this.eventBusComponent.emit(r.WEAPON_CHANGED,{weaponType:this.weaponType}),this.bulletGroup&&this.destroyGroup(this.bulletGroup),this.homingBulletGroup&&this.destroyGroup(this.homingBulletGroup),this.bulletGroup=this.gameObject.scene.physics.add.group({name:"player-bullets-".concat(o().Math.RND.uuid()),classType:o().Physics.Arcade.Sprite,maxSize:200,runChildUpdate:!1}),this.bulletGroup.createMultiple({key:this.bulletConfig.texture,quantity:200,active:!1,visible:!1}),this.gameObject.scene.physics.world.on(o().Physics.Arcade.Events.WORLD_STEP,this.worldStep,this),this.gameObject.once(o().GameObjects.Events.DESTROY,this.cleanup,this),this.cleanupTimer=this.gameObject.scene.time.addEvent({delay:100,callback:this.cleanupOffscreenBullets,callbackScope:this,loop:!0}),this.laserBeam=this.gameObject.scene.add.graphics(),this.laserGlow=this.gameObject.scene.add.graphics(),this.laserBeam.setDepth(1),this.laserGlow.setDepth(0),this.laserBeam.setVisible(!1),this.laserGlow.setVisible(!1),this.homingBulletGroup&&this.destroyGroup(this.homingBulletGroup),this.homingBulletGroup=this.gameObject.scene.physics.add.group({name:"homing-bullets-".concat(o().Math.RND.uuid()),classType:o().Physics.Arcade.Sprite,maxSize:80,runChildUpdate:!1});let n=S.homing.homing.texture;this.homingBulletGroup.createMultiple({key:n,quantity:80,active:!1,visible:!1}),this.eventBusComponent.on(r.ADD_POWER,e=>{this.addPower(e)})}}class C extends o().GameObjects.Container{canPickup(e){return o().Math.Distance.Between(this.x,this.y,e.x,e.y)<=this._pickupRadius}setupTestControls(){this.scene.input.keyboard&&(this.scene.input.keyboard.on("keydown-P",()=>{this.increasePower(50),console.log("Power: ".concat(this.getPower()," (Level ").concat(this.getPowerLevel(),")"))}),this.scene.input.keyboard.on("keydown-O",()=>{this.increasePower(-this.getPower()),console.log("Power reset")}))}increasePower(e){this._weapon.addPower(e)}getPower(){return this._weapon.getPower()}getPowerLevel(){return this._weapon.getPowerLevel()}get powerLevel(){return this._weapon.getPowerLevel()}get collider(){return this._collider}get health(){return this._health}get weaponGroup(){return this._weapon.getBulletGroup()}get weapon(){return this._weapon}get isInvulnerable(){return this._isInvulnerable}update(e,t){if(this.active){if(this._health.isDead){this.handleDeath();return}this._keyboardInput.update(),this._horizontalMovement.update(),this._verticalMovement.update(),this._weapon.update(t),this._keyboardInput.thirdActionIsDown?(this._isWeaponChanged||this.cycleWeaponType(),this._isWeaponChanged=!0):this._isWeaponChanged=!1,this.updateHitboxIndicator(),this._keyboardInput.secondaryActionIsDown&&!this._isBombActive&&!this._bombCooldown&&this._bombsCount>0&&this.activateBomb()}}activateBomb(){this._isInvulnerable||(this._bombsCount--,this._isBombActive=!0,this._bombCooldown=!0,this.showBombInitialFlash(),this.showBombPersistentEffect(),this.activateInvulnerability(I.duration),this._eventBus.emit(r.PLAYER_BOMB_ACTIVATED),this._bombTimer=this.scene.time.delayedCall(I.duration,this.deactivateBomb,[],this),this.scene.time.delayedCall(I.cooldown,()=>this._bombCooldown=!1,[],this),this.scene.time.addEvent({delay:I.damageInterval,callback:()=>{this._eventBus.emit(r.PLAYER_BOMB_DAMAGE_TICK)},callbackScope:this,repeat:Math.floor(I.duration/I.damageInterval)}),this._eventBus.emit(r.BOMB_COUNT_CHANGED,this._bombsCount))}deactivateBomb(){this._isBombActive=!1,this.scene.tweens.add({targets:this._bombEffect,alpha:0,duration:500,onComplete:()=>this._bombEffect.setVisible(!1)}),this._bombTimer&&(this._bombTimer.destroy(),this._bombTimer=null)}showBombInitialFlash(){let e=this.scene.add.graphics().fillStyle(16777215,1).fillRect(0,0,this.scene.scale.width,this.scene.scale.height).setDepth(1);this.scene.tweens.add({targets:e,alpha:0,duration:300,ease:"Cubic.easeOut",onComplete:()=>e.destroy()})}showBombPersistentEffect(){this._bombEffect.clear(),this._bombEffect.fillStyle(8956671,.8),this._bombEffect.fillRect(0,0,this.scene.scale.width,this.scene.scale.height),this._bombEffect.setVisible(!0),this.scene.tweens.add({targets:this._bombEffect,alpha:{from:.3,to:.1},duration:1e3,yoyo:!0,repeat:-1})}resetBombs(){this._bombsCount=I.count,this._isBombActive=!1,this._bombCooldown=!1,this._bombEffect.setVisible(!1),this._eventBus.emit(r.BOMB_COUNT_CHANGED,this._bombsCount)}cycleWeaponType(){let e=this._weapon.getWeaponType()%3+1;this._weapon.setWeaponType(e),this._eventBus.emit(r.WEAPON_CHANGED,{weaponType:e})}updateHitboxIndicator(){if(this._focusIndicator.clear(),this._keyboardInput.focusIsDown&&this.body){let e=this.body;this._focusIndicator.fillStyle(16711680,1),this._focusIndicator.fillCircle(e.offset.x+e.width/2,e.offset.y+e.height/2,3),this._focusIndicator.lineStyle(1,16711680,.5),this._focusIndicator.strokeRect(e.offset.x,e.offset.y,e.width,e.height)}}handleDeath(){this.hide(),this._weapon.deactivateLaser(),this.resetBombs(),this.setVisible(!0),this._shipSprite.play("explosion"),this._eventBus.emit(r.PLAYER_DESTROYED)}hide(){this.body&&this.body instanceof o().Physics.Arcade.Body&&(this.body.enable=!1,this.body.stop()),this.setActive(!1).setVisible(!1),this._engineSprite.setVisible(!1),this._thrusterSprite.setVisible(!1),this._keyboardInput.lockInput=!0,this.scene.physics.world.disable(this)}spawn(){this.scene&&!this.ignoreDestroy&&(this.scene.physics.world.enable(this),this.body&&this.body instanceof o().Physics.Arcade.Body&&(this.body.enable=!0,this.body.velocity.set(0,0)),this.setActive(!0).setVisible(!0),this._engineSprite.setVisible(!0),this._thrusterSprite.setVisible(!0),this._shipSprite.setTexture("ship",0),this._health.reset(),this.setPosition(this.scene.scale.width/2,this.scene.scale.height-32),this._keyboardInput.lockInput=!1,this.activateInvulnerability(3e3))}activateInvulnerability(e){this.deactivateInvulnerability(),this._isInvulnerable=!0,this._blinkTween=this.scene.tweens.add({targets:[this._shipSprite,this._engineSprite,this._thrusterSprite],alpha:{from:.3,to:1},duration:300,yoyo:!0,repeat:-1}),this._invulnerabilityTimer=this.scene.time.delayedCall(e,()=>{this.deactivateInvulnerability()})}deactivateInvulnerability(){this._isInvulnerable&&(this._isInvulnerable=!1,this._blinkTween&&(this._blinkTween.stop(),this._blinkTween=null),this._shipSprite.setAlpha(1),this._engineSprite.setAlpha(1),this._thrusterSprite.setAlpha(1),this._invulnerabilityTimer&&(this._invulnerabilityTimer.destroy(),this._invulnerabilityTimer=null))}cleanup(){var e;this.deactivateInvulnerability(),null===(e=this.scene)||void 0===e||e.events.off(o().Scenes.Events.UPDATE,this.update,this),this._eventBus.off(r.PLAYER_SPAWN,this.spawn,this),this._weapon.cleanup(),this._bombTimer&&(this._bombTimer.destroy(),this._bombTimer=null),this._bombEffect.destroy()}constructor(e,t){var s;if(super(e,e.scale.width/2,e.scale.height-32,[]),s=this,this._isInvulnerable=!1,this._invulnerabilityTimer=null,this._blinkTween=null,this._isBombActive=!1,this._bombTimer=null,this._bombCooldown=!1,this._isWeaponChanged=!1,this._pickupRadius=30,this.scene.add.existing(this),this.scene.physics.add.existing(this),!this.body)throw Error("Physics body not created for FighterEnemy");this.body instanceof o().Physics.Arcade.Body&&(this.body.setSize(4,4),this.body.setOffset(-1.9,0),this.body.setCollideWorldBounds(!0),this.setDepth(2)),this._eventBus=t,this._shipSprite=e.add.sprite(0,0,"ship"),this._engineSprite=e.add.sprite(0,0,"ship_engine"),this._thrusterSprite=e.add.sprite(0,0,"ship_engine_thruster"),this._thrusterSprite.play("ship_engine_thruster"),this.add([this._thrusterSprite,this._engineSprite,this._shipSprite]),this._keyboardInput=new f(e),this._horizontalMovement=new g(this,this._keyboardInput,250),this._verticalMovement=new y(this,this._keyboardInput,250),this._weapon=new E(this,this._keyboardInput,t),this._health=new p(1),this._collider=new d(this._health,t),this.hide(),t.on(r.PLAYER_SPAWN,this.spawn,this),this._eventBus.on(r.ADD_LIFE,function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;s._health.setLife(s._health.life+e)}),this._eventBus.on(r.ADD_BOMB,function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;s._bombsCount=s._bombsCount+e,s._eventBus.emit(r.BOMB_COUNT_CHANGED,s._bombsCount)}),e.events.on(o().Scenes.Events.UPDATE,this.update,this),this.once(o().GameObjects.Events.DESTROY,this.cleanup,this),this._focusIndicator=e.add.graphics(),this._focusIndicator.setDepth(10),this.add(this._focusIndicator),this._bombsCount=I.count,this._bombEffect=e.add.graphics(),this._bombEffect.setDepth(-5),this._bombEffect.setVisible(!1),this.setupTestControls()}}class A{constructor(e,t){this.scene=e,this.eventBusComponent=t,this.group=this.scene.add.group({name:"".concat(this.constructor.name,"-").concat(o().Math.RND.uuid()),classType:o().GameObjects.Sprite}),this.eventBusComponent.on(r.ENEMY_DESTROYED,e=>{let t=this.group.get(e.x,e.y,e.shipAssetKey);t&&t.play(e.shipDestroyedAnimationKey)})}}let T={ScoutEnemy:100,FighterEnemy:200};class x extends o().GameObjects.Text{setupEventListeners(){this.eventBusComponent.on(r.ENEMY_DESTROYED,e=>{if(this.isActive)return;let t=e.constructor.name;T[t]&&this.addScore(T[t])}),this.eventBusComponent.on(r.ENEMY_HIT,()=>{this.isActive&&this.addScore(10)}),this.eventBusComponent.on(r.ADD_BONUS_SCORE,e=>{this.isActive&&this.addScore(e)}),this.eventBusComponent.on(r.ADD_SCORE,e=>{this.isActive&&this.addScore(e)})}addScore(e){if(this.isActive)try{this.currentScore+=e,this.updateScoreText(),this.scene.registry.set("score",this.currentScore),this.scene.tweens.add({targets:this,scaleX:1.2,scaleY:1.2,duration:100,yoyo:!0})}catch(e){console.log(e)}}updateScoreText(){this.active&&this.scene&&(this.setText(this.currentScore.toString()),this.currentScore.toString().length>6?this.setFontSize("18px"):this.setFontSize("24px"))}get score(){return this.currentScore}destroy(e){this.isActive=!1,this.eventBusComponent.off(r.ENEMY_DESTROYED),this.eventBusComponent.off(r.SHIP_HIT),this.eventBusComponent.off(r.ADD_BONUS_SCORE),this.scene&&this.scene.tweens.killTweensOf(this),super.destroy(e)}resetScore(e){this.currentScore=e,this.updateScoreText(),this.scene&&this.scene.registry.set("score",this.currentScore)}constructor(e,t){super(e,e.scale.width-10,10,"0",{fontSize:"24px",color:"#ff2f66",fontFamily:"Arial",align:"right"}),this.isActive=!0,this.currentScore=0,this.eventBusComponent=t,e.add.existing(this),this.setOrigin(1,0),e.registry.set("score",this.currentScore),this.setupEventListeners()}}class B extends o().GameObjects.Container{createLivesIcons(){this.livesIcons.forEach(e=>e.destroy()),this.livesIcons=[],this.removeAll(!0);for(let e=0;e<this.currentLives;e++){let t=this.scene.add.image(20*e,0,"ship").setScale(.6).setOrigin(0);this.add(t),this.livesIcons.push(t)}}setupEventListeners(){this.eventBusComponent.on(r.PLAYER_DESTROYED,()=>{this.handlePlayerDestroyed()}),this.eventBusComponent.on(r.ADD_LIFE,()=>{this.currentLives=this.currentLives+1,this.createLivesIcons()})}handlePlayerDestroyed(){if(this.currentLives--,this.livesIcons[this.currentLives]&&this.livesIcons[this.currentLives].destroy(),this.currentLives>0){this.scene.time.delayedCall(1500,()=>{this.eventBusComponent.emit(r.PLAYER_SPAWN)});return}this.scene.time.delayedCall(1e3,()=>{this.eventBusComponent.emit(r.GAME_OVER)})}get livesCount(){return this.currentLives}destroy(e){this.eventBusComponent.off(r.PLAYER_DESTROYED),this.eventBusComponent.off(r.ADD_LIFE),super.destroy(e)}resetLives(){this.livesIcons.forEach(e=>e.destroy()),this.livesIcons=[],this.currentLives=3,this.createLivesIcons()}constructor(e,t){super(e,5,e.scale.height-30),this.livesIcons=[],this.currentLives=3,this.eventBusComponent=t,e.add.existing(this),this.createLivesIcons(),this.setupEventListeners(),this.eventBusComponent.emit(r.PLAYER_SPAWN)}}class D{update(e,t){this.activeBullets.forEach(e=>{if(!e.active){this.activeBullets.delete(e);return}let s=e.getData("lifespan")-t;if(e.setData("lifespan",s),this.debug&&s<=0){var i;console.log("Disabling bullet via update",null===(i=e.body)||void 0===i?void 0:i.velocity)}s<=0&&(e.disableBody(!0,!0),this.activeBullets.delete(e));let n=e.getData("behaviors");n&&n.forEach(s=>s.update(e,t))})}spawn(e){e.directions.forEach(t=>{var s,i,n,a,o,r;let h=this.bulletGroup.getFirstDead(!1);if(!h){this.debug&&console.warn("No available bullets in pool!");return}let l=null!==(a=null===(s=e.spawnPosition)||void 0===s?void 0:s.x)&&void 0!==a?a:this.owner.x,c=null!==(o=null===(i=e.spawnPosition)||void 0===i?void 0:i.y)&&void 0!==o?o:this.owner.y;h.enableBody(!0,l,c,!0,!0),h.setData("lifespan",e.lifespan),h.setScale(null!==(r=e.scale)&&void 0!==r?r:1),e.size&&(null===(n=h.body)||void 0===n||n.setSize(e.size.width,e.size.height)),e.animationKey&&h.play(e.animationKey),e.flipY&&h.setFlipY(!0),e.behaviors?h.setData("behaviors",e.behaviors):h.setData("behaviors",null),h.body&&(h.body.velocity.x=t.x*e.speed,h.body.velocity.y=t.y*e.speed),this.activeBullets.add(h)})}destroyBullet(e){e.active&&(e.setData("behaviors",null),e.disableBody(!0,!0),this.activeBullets.delete(e))}bulletClear(){this.activeBullets.forEach(e=>{e.setData("behaviors",null),this.destroyBullet(e)})}cleanup(){var e;this.activeBullets.clear(),this.bulletGroup.clear(!0,!0),null===(e=this.owner.scene)||void 0===e||e.events.off("update",this.update,this)}getGroup(){return this.bulletGroup}constructor(e,t,s,i=2048){this.debug=!1,this.owner=t,this.activeBullets=new Set,this.bulletGroup=e.physics.add.group({name:"boss-bullets-".concat(o().Math.RND.uuid()),enable:!1,classType:o().Physics.Arcade.Sprite}),this.bulletGroup.createMultiple({key:s,quantity:i,active:!1,visible:!1}),this.bulletGroup.setDepth(6),e.events.on("update",this.update,this),t.once(o().GameObjects.Events.DESTROY,this.cleanup,this)}}class M extends o().GameObjects.Container{initPhysics(){this.scene.add.existing(this),this.scene.physics.add.existing(this),this.body instanceof o().Physics.Arcade.Body&&this.body.setSize(24,24).setOffset(-12,-12)}init(e){for(var t=arguments.length,s=Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];if(!this.body)throw Error("Physics body missing");this._eventBusComponent=e,this._healthComponent=new p(this.getInitialHealth()),this._colliderComponent=new d(this._healthComponent,e),this._isInitialized=!0}reset(){this.body&&(this.body&&this.body instanceof o().Physics.Arcade.Body&&(this.body.enable=!0,this.body.checkCollision.none=!1,this.body.setVelocity(0)),this.setActive(!0).setVisible(!0),this._healthComponent.reset())}update(e,t){if(this._isInitialized&&this.active&&this.body){if(this._healthComponent.isDead){this.handleDeath();return}this.customUpdate(e,t)}}destroy(e){var t;null===(t=this.bulletSpawner)||void 0===t||t.bulletClear(),this.scene.events.off(o().Scenes.Events.UPDATE,this.update,this),super.destroy(e)}get healthComponent(){return this._healthComponent}get colliderComponent(){return this._colliderComponent}get bulletSpawner(){return this._bulletSpawner?this._bulletSpawner:null}get dropConfig(){return this._dropConfig}handleDeath(){var e;null===(e=this.bulletSpawner)||void 0===e||e.bulletClear(),this.setActive(!1).setVisible(!1),this.body&&this.body instanceof o().Physics.Arcade.Body&&(this.body.enable=!1,this.body.checkCollision.none=!0,this.body.stop()),this._eventBusComponent.emit(r.ENEMY_DESTROYED,this)}constructor(e,t,s){super(e,t,s,[]),this._isInitialized=!1,this._bulletSpawner=null,this._dropConfig=null,this.initPhysics(),this.initSprites(),e.events.on(o().Scenes.Events.UPDATE,this.update,this),this.setDepth(5)}}class P extends M{init(e,t){var s,i,n,a;super.init(e),this._playerGetter=t,this._phases=this.createPhases(),this._phaseTimeLeft=null!==(n=null===(s=this._phases[0])||void 0===s?void 0:s.duration)&&void 0!==n?n:0,this._healthComponent.setLife(null!==(a=null===(i=this._phases[0])||void 0===i?void 0:i.health)&&void 0!==a?a:1),this._isInvulnerable=!0,this.initScreenSections(),this.body&&(this.body.velocity.y=this._movementSpeed,this._targetPosition={x:this.x,y:this._verticalRange.min}),e.emit(r.BOSS_SPAWNED,this)}initScreenSections(){let e=this.scene.scale.width/5;this._sections=Array.from({length:5},(t,s)=>({min:s*e,max:(s+1)*e}))}isInvulnerable(){return this._isInvulnerable}setInvulnerable(e){this._isInvulnerable=!0,this.invulnerabilityTimer=this.scene.time.delayedCall(e,()=>{this._isInvulnerable=!1})}customUpdate(e,t){if(!this._spawnComplete){this.handleSpawnMovement();return}let s=this._phases[this._currentPhaseIndex];s&&(this._phaseTimeLeft-=t,this._phaseTimeLeft<=0&&this.handlePhaseTransition(),s.update(e,t),this.handleMovement(e,t))}handleDeath(){if(!this._isPhaseTransitioning){if(this._currentPhaseIndex>=this._phases.length-1){var e;super.handleDeath(),this._eventBusComponent.emit(r.BOSS_DEFEATED,this),null===(e=this.bulletSpawner)||void 0===e||e.cleanup()}else this._isPhaseTransitioning=!0,this.handlePhaseTransition()}}handlePhaseTransition(){var e,t;let s=this._phases[this._currentPhaseIndex];if(null===(e=s.onExit)||void 0===e||e.call(s),this._currentPhaseIndex++,this._currentPhaseIndex>=this._phases.length){this._healthComponent.die();return}let i=this._phases[this._currentPhaseIndex];this._phaseTimeLeft=i.duration,this._healthComponent.reset(),this._healthComponent.setLife(i.health),this.setInvulnerable(2e3),null===(t=this.bulletSpawner)||void 0===t||t.bulletClear(),this._eventBusComponent.emit(r.BOSS_PHASE_CHANGE,this),this.scene.time.delayedCall(500,()=>{var e;null===(e=i.onEnter)||void 0===e||e.call(i),this._isPhaseTransitioning=!1})}handleMovement(e,t){if(!this.body){console.log("Movement skipped: no physics body");return}let s=Date.now();switch(this._movementState){case"waiting":s-this._lastMovementChangeTime>=this._movementChangeCooldown&&(this.chooseNewTarget(),this._movementState="moving");break;case"moving":let i=this._targetPosition.x-this.x,n=this._targetPosition.y-this.y;10>Math.sqrt(i*i+n*n)?(this.body.velocity.set(0,0),this._lastMovementChangeTime=s,this._movementState="waiting"):this.updateVelocity()}}chooseNewTarget(){var e;let t=null===(e=this._playerGetter)||void 0===e?void 0:e.call(this);if(!t)return;let s=this.getCurrentSection(),i=this._sections.findIndex(e=>t.x>=e.min&&t.x<e.max),n=s;i===s?0===s||4===s?n=0===s?1:3:n+=Math.sign(t.x-this.x)||o().Math.Between(-1,1):n+=Math.sign(i-s),n=o().Math.Clamp(n,0,4);let a=this._sections[n];this._targetPosition={x:o().Math.Clamp(o().Math.Between(a.min,a.max),this._screenMargin,this.scene.scale.width-this._screenMargin),y:o().Math.Between(this._verticalRange.min+this._screenMargin,this._verticalRange.max)}}updateVelocity(){if(!this.body)return;let e=this._targetPosition.x-this.x,t=this._targetPosition.y-this.y,s=Math.sqrt(e*e+t*t);if(0===s)return;let i=this._movementSpeed;this.body.velocity.set(e/s*i,t/s*i)}getCurrentSection(){return this._sections.findIndex(e=>this.x>=e.min&&this.x<e.max)}handleSpawnMovement(){this.body&&this.y>=this._verticalRange.min&&(this.body.velocity.set(0,0),this._spawnComplete=!0,this._isInvulnerable=!1,this.scene.time.delayedCall(1e3,()=>{var e,t;null===(t=this._phases[0])||void 0===t||null===(e=t.onEnter)||void 0===e||e.call(t)}))}reset(){var e,t,s,i,n,a;super.reset(),this._currentPhaseIndex=0,this._phases=this.createPhases(),this._phaseTimeLeft=null!==(n=null===(e=this._phases[0])||void 0===e?void 0:e.duration)&&void 0!==n?n:0,this._healthComponent.setLife(null!==(a=null===(t=this._phases[0])||void 0===t?void 0:t.health)&&void 0!==a?a:1),null===(i=this._phases[0])||void 0===i||null===(s=i.onEnter)||void 0===s||s.call(i),this._spawnComplete=!1,this._isInvulnerable=!0}get currentPhaseIndex(){return this._currentPhaseIndex}get bulletSpawner(){return this._bulletSpawner}set bulletSpawner(e){this._bulletSpawner=e}constructor(e,t,s){super(e,t,s),this._phases=[],this._currentPhaseIndex=0,this._phaseTimeLeft=0,this._lastMovementChangeTime=0,this._movementChangeCooldown=3e3,this._isInvulnerable=!0,this._isPhaseTransitioning=!1,this._spawnComplete=!1,this._verticalRange={min:50,max:200},this._targetPosition={x:0,y:100},this._movementSpeed=100,this._screenMargin=20,this._currentSection=0,this._sections=[],this._movementState="waiting"}}class O extends P{initSprites(){this._shipSprite=this.scene.add.sprite(0,0,"fighter",0),this._engineSprite=this.scene.add.sprite(0,0,"fighter_engine").setFlipY(!0).play("fighter_engine"),this.add([this._engineSprite,this._shipSprite])}createPhases(){return[{health:1e3,duration:3e4,dropItems:[{type:"HEALTH",count:1,spread:30},{type:"BOMB",count:1,spread:30}],onEnter:()=>{this.fireInterval=200,this._movementSpeed=120,this._movementChangeCooldown=2e3},update:(e,t)=>{var s;if(e-this.lastShootTime<this.fireInterval||this.isInvulnerable())return;this.lastShootTime=e;let i=null===(s=this._playerGetter)||void 0===s?void 0:s.call(this);if(!i)return;let n=Phaser.Math.RadToDeg(Phaser.Math.Angle.Between(this.x,this.y,i.x,i.y)),a=[-30,-20,-10,0,10,20,30].map(e=>{let t=n+e;return new Phaser.Math.Vector2(Math.cos(Phaser.Math.DegToRad(t)),Math.sin(Phaser.Math.DegToRad(t)))});this.bulletSpawner.spawn({directions:a,speed:400,lifespan:6e3,animationKey:"bullet",size:{width:14,height:18},flipY:!1,scale:.8})}},{health:1200,duration:3e4,onEnter:()=>{this.fireInterval=300,this._movementSpeed=180,this._movementChangeCooldown=1500,this._shotCounter=0,this._lineOffset=0},update:(e,t)=>{if(e-this.lastShootTime<this.fireInterval||this.isInvulnerable())return;this.lastShootTime=e;let s=this.scene.scale.width,i=s/6;this._shotCounter%1==0&&(this._lineOffset=(this._lineOffset+.2*i)%(10*i)),this._shotCounter++,Array(6).fill(0).forEach((e,t)=>{let n=((t+.5)*i+this._lineOffset)%s,a=t%2==0?0:this.scene.scale.height;this.bulletSpawner.spawn({directions:[new Phaser.Math.Vector2(0,t%2==0?1:-1)],speed:t%2==0?200:300,lifespan:4e3,animationKey:"bullet",size:{width:14,height:18},flipY:!0,scale:.8,spawnPosition:{x:n,y:a}})})}},{health:1200,duration:3e4,onEnter:()=>{this._targetPosition={x:this.scene.scale.width/2,y:150},this._movementState="moving",this._movementChangeCooldown=1/0,this.scene.time.delayedCall(100,()=>{this.body&&10>Phaser.Math.Distance.BetweenPoints(this._targetPosition,this.body.position)&&this.body.velocity.set(0,0)},[],this),this.fireInterval=40},update:(e,t)=>{if(e-this.lastShootTime<this.fireInterval||this.body&&0!=this.body.velocity.x&&0!=this.body.velocity.y||this.isInvulnerable())return;this.lastShootTime=e;let s=[,,,,].fill(0).map(()=>{let e;return 25>=Phaser.Math.Between(1,100)?e=-1.5*Math.PI+Phaser.Math.FloatBetween(-.5,.5):e=Phaser.Math.FloatBetween(0,2*Math.PI),new Phaser.Math.Vector2(Math.cos(e),Math.sin(e))});this.bulletSpawner.spawn({directions:s,speed:Phaser.Math.Between(300,550),lifespan:2e3,animationKey:"bullet",size:{width:14,height:18},flipY:!1,scale:.8})}},{health:3500,duration:6e4,onEnter:()=>{this._targetPosition={x:this.scene.scale.width/2,y:this.scene.scale.height/2-50},this._movementState="moving",this._movementChangeCooldown=1/0,this.scene.time.delayedCall(100,()=>{this.body&&10>Phaser.Math.Distance.BetweenPoints(this._targetPosition,this.body.position)&&this.body.velocity.set(0,0)},[],this),this.fireInterval=30,this._patternAngle=0,this._patternCounter=0},update:(e,t)=>{if(e-this.lastShootTime<this.fireInterval||this.body&&0!=this.body.velocity.x&&0!=this.body.velocity.y||this.isInvulnerable())return;this.lastShootTime=e;let s=[,,,,,].fill(0).map((e,t)=>{let s=this._patternAngle+72*t,i=Phaser.Math.DegToRad(s);return new Phaser.Math.Vector2(Math.cos(i),Math.sin(i))});this.bulletSpawner.spawn({directions:s,speed:240,lifespan:2e3,animationKey:"bullet",size:{width:14,height:18},flipY:!1,scale:.8}),this._patternAngle+=20*Math.sin(Phaser.Math.DegToRad(this._patternCounter)),this._patternCounter++}}]}init(e,t){super.init(e,t),this.bulletSpawner=new D(this.scene,this,"bullet",300),this.initSprites(),this.initPhysics()}initPhysics(){this.scene.add.existing(this),this.scene.physics.add.existing(this),this.body instanceof Phaser.Physics.Arcade.Body&&this.body.setSize(this.hitboxWidth,this.hitboxHeight).setOffset(this.hitboxOffsetX,this.hitboxOffsetY),this.setScale(2)}getInitialHealth(){return 100}reset(){super.reset(),this._engineSprite.setVisible(!0),this.bulletSpawner.bulletClear()}destroy(e){var t;this._engineSprite.destroy(e),super.destroy(e),null===(t=this.bulletSpawner)||void 0===t||t.bulletClear()}get shipAssetKey(){return"fighter"}get shipDestroyedAnimationKey(){return"fighter_destroy"}constructor(...e){super(...e),this.lastShootTime=0,this.fireInterval=200,this._spiralAngle=0,this._splitTimer=0,this._homingTimer=0,this.hitboxWidth=48,this.hitboxHeight=48,this.hitboxOffsetX=-24,this.hitboxOffsetY=-24}}class k{initEventListeners(){l.on("BOSS_HEALTH_CHANGE",this.updateUI,this),l.on("BOSS_PHASE_CHANGE",this.handlePhaseChange,this),this._scene.events.on(o().Scenes.Events.UPDATE,this.updatePhaseTimer,this)}createUIElements(){this.destroyElements(),this.createHealthBar(),this.createTextElements(),this.createPhaseTimer()}setBoss(e){this._boss=e,this._phaseStartTime=this._scene.time.now,this.createUIElements(),this.updatePhaseIndicators(),this.updateUI()}createHealthBar(){this._currentHealthBarBg=this._scene.add.graphics().fillStyle(3355443,.8).fillRect(this._margin,this._margin,this._barWidth,this._barHeight).setScrollFactor(0).setDepth(100),this._currentHealthBar=this._scene.add.graphics().fillStyle(16711680,1).fillRect(this._margin,this._margin,this._barWidth,this._barHeight).setScrollFactor(0).setDepth(101)}createTextElements(){this._healthText=this._scene.add.text(this._margin,this._margin+this._barHeight+this._indicatorSize+10,"BOSS: 100%",{fontFamily:"Arial",fontSize:"14px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(0,0).setScrollFactor(0).setDepth(100)}createPhaseTimer(){this._phaseTimerText=this._scene.add.text(this._margin+this._barWidth-5,this._margin+this._barHeight+6,"",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(1,0).setScrollFactor(0).setDepth(100)}updateUI(){var e,t;if(!this._boss||!this._boss.healthComponent){this.destroy();return}let s=this._boss.currentPhaseIndex,i=this._boss._phases[s],n=Math.floor(this._boss.healthComponent.life/i.health*100),a=this._boss.healthComponent.life/i.health*this._barWidth;null===(e=this._currentHealthBar)||void 0===e||e.clear().fillStyle(this.getHealthColor(n),1).fillRect(this._margin,this._margin,a,this._barHeight),null===(t=this._healthText)||void 0===t||t.setText("BOSS: ".concat(n,"%"))}updatePhaseIndicators(){if(!this._boss)return;this._phaseIndicators.forEach(e=>e.destroy()),this._phaseIndicators=[];let e=this._boss._phases.length,t=this._boss.currentPhaseIndex,s=this._margin,i=this._margin+this._barHeight+8;for(let n=t+1;n<e;n++){let e=s+(n-t-1)*15,a=this._scene.add.graphics().fillStyle(16777215,1).lineStyle(1,16777215,.8);this.drawStar(a,e+6,i+6,5,6,3),a.setScrollFactor(0).setDepth(102),this._phaseIndicators.push(a)}}drawStar(e,t,s,i,n,a){let o=Math.PI/i,r=Math.PI/2*3;e.beginPath(),e.moveTo(t,s-n);for(let h=0;h<i;h++){let i=t+Math.cos(r)*n,h=s+Math.sin(r)*n;e.lineTo(i,h);let l=t+Math.cos(r+=o)*a,c=s+Math.sin(r)*a;e.lineTo(l,c),r+=o}e.lineTo(t,s-n),e.closePath(),e.fillPath(),e.strokePath()}getHealthColor(e){return e>60?65280:e>30?16776960:16711680}destroy(){l.off("BOSS_HEALTH_CHANGE",this.updateUI,this),l.off("BOSS_PHASE_CHANGE",this.handlePhaseChange,this),this._scene.events.off(o().Scenes.Events.UPDATE,this.updatePhaseTimer,this),this.destroyElements()}destroyElements(){var e,t,s,i;null===(e=this._currentHealthBar)||void 0===e||e.destroy(),null===(t=this._currentHealthBarBg)||void 0===t||t.destroy(),null===(s=this._healthText)||void 0===s||s.destroy(),null===(i=this._phaseTimerText)||void 0===i||i.destroy(),this._phaseIndicators.forEach(e=>e.destroy()),this._currentHealthBar=null,this._currentHealthBarBg=null,this._healthText=null,this._phaseTimerText=null,this._phaseIndicators=[]}constructor(e){this._currentHealthBar=null,this._currentHealthBarBg=null,this._phaseIndicators=[],this._healthText=null,this._boss=null,this._phaseTimerText=null,this._phaseStartTime=0,this.handlePhaseChange=()=>{this._phaseStartTime=this._scene.time.now,this.updatePhaseIndicators(),this.updateUI()},this.updatePhaseTimer=()=>{if(!this._boss||!this._phaseTimerText)return;let e=this._boss.currentPhaseIndex,t=this._boss._phases[e];if(!(null==t?void 0:t.duration)){var s;null===(s=this._phaseTimerText)||void 0===s||s.setText("");return}let i=this._scene.time.now-this._phaseStartTime,n=Math.max(0,t.duration-i);this._phaseTimerText.setText("".concat(Math.ceil(n/1e3),"s"))},this._scene=e,this._barWidth=.75*e.scale.width,this._barHeight=12,this._margin=10,this._indicatorSize=10,this.initEventListeners()}}class L{startLevel(e){this.currentLevel=e,this.currentWave=0,this.startWave()}startWave(){this.waveConfig=this.levels[this.currentLevel].waves[this.currentWave];let e=this.waveConfig.initialDelay||0;e>0?this.scene.time.delayedCall(e,()=>{this.startWaveImmediately()}):this.startWaveImmediately()}startWaveImmediately(){l.emit(r.RESET_ALL_SPAWNERS),this.waveConfig=this.levels[this.currentLevel].waves[this.currentWave],this.enemiesAlive=0,this.hasLimitedSpawners=this.waveConfig.spawners.some(e=>void 0!==e.count),console.log("Starting wave ".concat(this.currentWave+1," of level ").concat(this.currentLevel+1)),l.on(r.ENEMY_INIT,this.onEnemySpawned,this),l.on(r.ENEMY_DESTROYED,this.onEnemyDestroyed,this),this.waveConfig.spawners.forEach(e=>{l.emit(r.START_SPAWNER,e)}),this.waveTimer=this.scene.time.delayedCall(this.waveConfig.duration,()=>{this.endWave(this.waveConfig.delayAfter)})}onEnemySpawned(){this.enemiesAlive++}onEnemyDestroyed(){this.enemiesAlive--,this.hasLimitedSpawners&&this.enemiesAlive<=0&&this.earlyWaveCompletion()}earlyWaveCompletion(){this.waveTimer&&this.waveTimer.destroy(),this.endWave(this.waveConfig.delayAfter)}endWave(e){l.off(r.ENEMY_INIT,this.onEnemySpawned,this),l.off(r.ENEMY_DESTROYED,this.onEnemyDestroyed,this),l.emit(r.STOP_ALL_SPAWNERS),this.currentWave<this.levels[this.currentLevel].waves.length-1?(this.currentWave++,this.scene.time.delayedCall(e,this.startWave,[],this)):this.scene.time.delayedCall(e,this.startBossFight,[],this)}startBossFight(){l.emit(r.RESET_ALL_SPAWNERS);let e=this.levels[this.currentLevel].boss;if(!e){this.levelComplete();return}this.currentBoss=this.createBoss(e.enemyType),this.currentBoss&&(this.currentBoss.init(l,()=>this.playerRef),this.bossUI&&this.bossUI.setBoss(this.currentBoss),l.emit(r.BOSS_INIT,this.currentBoss))}createBoss(e){return"firstBoss"===e?new O(this.scene,this.scene.scale.width/2,-100):(console.error("Unknown boss type: ".concat(e)),null)}levelComplete(){l.emit(r.LEVEL_COMPLETE,{level:this.currentLevel})}setupEventListeners(){l.on(r.BOSS_DEFEATED,()=>{this.bossUI&&(this.bossUI.destroy(),this.bossUI=new k(this.scene)),this.levelComplete()})}cleanup(){this.waveTimer&&this.waveTimer.destroy(),l.off(r.BOSS_DEFEATED),this.bossUI&&this.bossUI.destroy()}constructor(e,t){this.currentLevel=0,this.currentWave=0,this.enemiesAlive=0,this.hasLimitedSpawners=!1,this.scene=e,this.levels=t,this.levelsCount=t.length,this.setupEventListeners(),e.events.once(o().Scenes.Events.CREATE,()=>{this.playerRef=e.registry.get("player")}),this.bossUI=new k(this.scene)}}class R extends m{update(){}constructor(){super(),this.pressDown()}}class G extends M{init(e){super.init(e),this._inputComponent=new R,this._verticalMovementComponent=new y(this,this._inputComponent,200),this._bulletSpawner=new D(this.scene,this,"bullet",10),this._dropConfig={items:[{type:"POWER",chance:.7},{type:"SCORE",chance:.3}]},e.emit(r.ENEMY_INIT,this)}initSprites(){this._shipSprite=this.scene.add.sprite(0,0,"fighter",0),this._engineSprite=this.scene.add.sprite(0,0,"fighter_engine").setFlipY(!0).play("fighter_engine"),this.add([this._engineSprite,this._shipSprite])}get shipAssetKey(){return"fighter"}get shipDestroyedAnimationKey(){return"fighter_destroy"}reset(){super.reset(),this._verticalMovementComponent.reset(),this._engineSprite.setVisible(!0),this._lastFireTime=0}getInitialHealth(){return 250}customUpdate(e,t){this._inputComponent.update(),this._verticalMovementComponent.update(),e-this._lastFireTime>=2e3&&(this.fireBullet(),this._lastFireTime=e)}fireBullet(){var e;null===(e=this._bulletSpawner)||void 0===e||e.spawn({directions:[new(o()).Math.Vector2(0,-1)],speed:-280,lifespan:3e4,size:{width:14,height:18},animationKey:"bullet",flipY:!0,scale:.8,spawnPosition:{x:this.x,y:this.y+10}}),this._eventBusComponent.emit(r.SHIP_SHOOT)}destroy(e){this._bulletSpawner&&this._bulletSpawner.cleanup(),this._engineSprite.destroy(e),super.destroy(e)}constructor(e,t,s){super(e,t,s),this._lastFireTime=0,this.initSprites()}}G.enemyType="fighter";class H extends m{setStartX(e){this.startX=e}update(){let e=this.gameObject.x;e>this.startX+this.maxXMovement?(this.pressLeft(),this.releaseRight()):e<this.startX-this.maxXMovement&&(this.releaseLeft(),this.pressRight())}constructor(e){super(),this.gameObject=e,this.startX=e.x,this.maxXMovement=40,this.pressRight(),this.pressDown(),this.releaseLeft()}}class F extends M{init(e){super.init(e),this._inputComponent=new H(this),this._horizontalMovementComponent=new g(this,this._inputComponent,110),this._verticalMovementComponent=new y(this,this._inputComponent,180),e.emit(r.ENEMY_INIT,this)}initSprites(){this._shipSprite=this.scene.add.sprite(0,0,"scout",0),this._engineSprite=this.scene.add.sprite(0,0,"scout_engine").setFlipY(!0).play("scout_engine"),this.add([this._engineSprite,this._shipSprite])}get shipAssetKey(){return"scout"}get shipDestroyedAnimationKey(){return"scout_destroy"}reset(){super.reset(),this._inputComponent.setStartX(this.x),this._verticalMovementComponent.reset(),this._horizontalMovementComponent.reset(),this._engineSprite.setVisible(!0)}getInitialHealth(){return 20}customUpdate(e,t){this._inputComponent.update(),this._horizontalMovementComponent.update(),this._verticalMovementComponent.update()}destroy(e){this._engineSprite.destroy(e),super.destroy(e)}constructor(e,t,s){super(e,t,s),this.initSprites(),this._dropConfig={items:[{type:"POWER",chance:.6},{type:"SCORE",chance:.3}]}}}F.enemyType="scout";class N{setupEventListeners(){this.eventBus.on(r.ENEMY_INIT,this.setupEnemyCollisions,this),this.eventBus.on(r.BOSS_INIT,this.setupBossCollisions,this),this.eventBus.on(r.BOSS_DEFEATED,this.cleanupDefeatedBossHandlers,this),this.eventBus.on(r.WEAPON_POWER_CHANGED,this.handleWeaponPowerChange,this),this.eventBus.on(r.PLAYER_BOMB_ACTIVATED,this.handleBombBulletClear,this),this.eventBus.on(r.PLAYER_BOMB_DAMAGE_TICK,this.handleBombDamageTick,this)}setupBaseCollisions(){if(!this.scene||!this.scene.physics.world)return;let e=this.spawnerManager.getAllSpawners().map(e=>e.phaserGroup);this.colliders.push(this.scene.physics.add.overlap(this.player,e,this.handlePlayerEnemyCollision),this.scene.physics.add.overlap(e,this.player.weaponGroup,this.handlePlayerBulletHit),this.scene.physics.add.overlap(e,this.currentHomingGroup,this.handleHomingBulletHit)),this.scene.events.on(Phaser.Scenes.Events.UPDATE,this.updateLaserCollisions,this),this.scene.events.on(Phaser.Scenes.Events.UPDATE,this.updateHomingBullets,this)}checkLaserBossCollision(e,t){return e.right>t.left&&e.left<t.right&&e.bottom>t.top}cleanupBossLaserHandler(e){let t=this.bossLaserHandlers.get(e);t&&(this.scene.events.off(Phaser.Scenes.Events.UPDATE,t),this.bossLaserHandlers.delete(e))}cleanupBossHomingHandler(e){let t=this.bossHomingHandlers.get(e);t&&(this.scene.events.off(Phaser.Scenes.Events.UPDATE,t),this.bossHomingHandlers.delete(e))}updateHomingBullets(){var e,t,s,i;if(!this.isActive||!(null===(t=this.scene)||void 0===t?void 0:null===(e=t.scene)||void 0===e?void 0:e.isActive()))return;let n=this.currentHomingGroup;if(n&&n.getChildren){if(!(null===(i=n.scene)||void 0===i?void 0:null===(s=i.scene)||void 0===s?void 0:s.isActive())){this.currentHomingGroup=this.player.weapon.getHomingBulletGroup();return}n.getChildren().forEach(e=>{if(!e.active||!e.body)return;let t=e.getData("homingData");if(t.delay-=this.scene.game.loop.delta,t.delay<=0){var s,i;if(t.target&&t.target.active||(t.target=this.findNearestTarget(e)),null===(s=t.target)||void 0===s?void 0:s.active)this.updateHomingBehavior(e,t.target,t.turnRate,t.speed);else{let s=Phaser.Math.Angle.Between(e.x,e.y,e.x,-100),n=Math.atan2(e.body.velocity.y,e.body.velocity.x),a=Phaser.Math.Angle.RotateTo(n,s,t.turnRate);null===(i=e.body)||void 0===i||i.velocity.set(Math.cos(a)*t.speed,Math.sin(a)*t.speed),e.setRotation(a+Math.PI/2)}}})}}findNearestTarget(e){var t;let s=null,i=1/0;if(null===(t=this.activeBoss)||void 0===t?void 0:t.active){let t=this.activeBoss,n=Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y);n<i&&(i=n,s=t)}return this.spawnerManager.getAllSpawners().forEach(t=>{t.phaserGroup.getChildren().forEach(t=>{if(!t.active)return;let n=Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y);n<i&&(i=n,s=t)})}),s}updateHomingBehavior(e,t,s,i){let n=Phaser.Math.Angle.Between(e.x,e.y,t.x,t.y),a=Math.atan2(e.body.velocity.y,e.body.velocity.x),o=Phaser.Math.Angle.RotateTo(a,n,s);e.body.velocity.set(Math.cos(o)*i,Math.sin(o)*i),e.setRotation(o+Math.PI/2)}cleanup(){this.isActive=!1,this.colliders.forEach(e=>{e.destroy()}),this.colliders=[],this.bossLaserHandlers.forEach((e,t)=>{this.cleanupBossLaserHandler(t)}),this.bossHomingHandlers.forEach((e,t)=>{this.cleanupBossHomingHandler(t)}),this.bossLaserHandlers.clear(),this.bossHomingHandlers.clear(),this.scene.events.off(Phaser.Scenes.Events.UPDATE,this.updateLaserCollisions,this),this.scene.events.off(Phaser.Scenes.Events.UPDATE,this.updateHomingBullets,this),this.eventBus.off(r.ENEMY_INIT,this.setupEnemyCollisions,this),this.eventBus.off(r.BOSS_INIT,this.setupBossCollisions,this),this.eventBus.off(r.BOSS_DEFEATED,this.cleanupDefeatedBossHandlers,this),this.eventBus.off(r.WEAPON_POWER_CHANGED,this.handleWeaponPowerChange,this),this.activeBoss=null}constructor(e,t,s,i){this.laserDamageTimer=0,this.LASER_DAMAGE_COOLDOWN=S.laser.fireRate,this.bossLaserHandlers=new Map,this.bossHomingHandlers=new Map,this.activeBoss=null,this.colliders=[],this.isActive=!0,this.currentHomingGroup=null,this.handleBombBulletClear=()=>{var e;this.spawnerManager.getAllSpawners().forEach(e=>{e.phaserGroup.getChildren().forEach(e=>{var t;null===(t=e.bulletSpawner)||void 0===t||t.bulletClear()})}),(null===(e=this.activeBoss)||void 0===e?void 0:e.bulletSpawner)&&this.activeBoss.bulletSpawner.bulletClear()},this.handleBombDamageTick=()=>{var e;this.handleBombBulletClear();let t=this.scene.cameras.main;if(this.spawnerManager.getAllSpawners().forEach(e=>{e.phaserGroup.getChildren().forEach(e=>{e.active&&t.worldView.contains(e.x,e.y)&&e.colliderComponent.collideWithEnemyProjectile(I.damage)})}),null===(e=this.activeBoss)||void 0===e?void 0:e.active){let e=this.activeBoss;t.worldView.contains(e.x,e.y)&&(this.activeBoss.colliderComponent.collideWithEnemyProjectile(I.damage),this.eventBus.emit(r.BOSS_HEALTH_CHANGE))}},this.handleWeaponPowerChange=e=>{this.currentHomingGroup=this.player.weapon.getHomingBulletGroup()},this.setupEnemyCollisions=e=>{e instanceof F||this.colliders.push(this.scene.physics.add.overlap(this.player,e.bulletSpawner.getGroup(),(t,s)=>{t.active&&s.active&&(e.bulletSpawner.destroyBullet(s),t.isInvulnerable||t.collider.collideWithEnemyProjectile())}))},this.setupBossCollisions=e=>{this.cleanupDefeatedBossHandlers(e),this.activeBoss=e,this.colliders.push(this.scene.physics.add.overlap(this.player,e,(e,t)=>{t.healthComponent.isDead||e.isInvulnerable||e.collider.collideWithEnemyShip()}),this.scene.physics.add.overlap(this.player,e.bulletSpawner.getGroup(),(e,t)=>{t.destroy(),e.isInvulnerable||e.collider.collideWithEnemyProjectile()}),this.scene.physics.add.overlap(e,this.player.weaponGroup,(e,t)=>{if(this.player.weapon.destroyBullet(t),!e.isInvulnerable()){let s=t.getData("damage")||1;e.colliderComponent.collideWithEnemyProjectile(s),this.eventBus.emit(r.ENEMY_HIT),this.eventBus.emit(r.BOSS_HEALTH_CHANGE)}}));let t=()=>{var t,s,i;if(!(null===(i=this.player)||void 0===i?void 0:null===(s=i.weapon)||void 0===s?void 0:null===(t=s.isLaserActive)||void 0===t?void 0:t.call(s))||e.isInvulnerable()||e.healthComponent.isDead)return;let n=this.player.weapon,a=n.laserHitArea,o=e.getBounds();this.checkLaserBossCollision(a,o)&&(e.colliderComponent.collideWithEnemyProjectile(n.laserDamagePerTick),this.eventBus.emit(r.ENEMY_HIT),this.eventBus.emit(r.BOSS_HEALTH_CHANGE))};this.scene.events.on(Phaser.Scenes.Events.UPDATE,t),this.bossLaserHandlers.set(e,t),this.colliders.push(this.scene.physics.add.overlap(e,this.currentHomingGroup,(e,t)=>{if(!e.isInvulnerable()){let s=t.getData("damage")||2;e.colliderComponent.collideWithEnemyProjectile(s),this.eventBus.emit(r.ENEMY_HIT),this.eventBus.emit(r.BOSS_HEALTH_CHANGE)}t.disableBody(!0,!0)}));let s=()=>{this.updateHomingBullets()};this.scene.events.on(Phaser.Scenes.Events.UPDATE,s),this.bossHomingHandlers.set(e,s)},this.cleanupDefeatedBossHandlers=e=>{this.activeBoss=null,this.cleanupBossLaserHandler(e),this.cleanupBossHomingHandler(e)},this.handlePlayerEnemyCollision=(e,t)=>{e.active&&t.active&&!e.isInvulnerable&&(e.collider.collideWithEnemyShip(),t.colliderComponent.collideWithEnemyShip())},this.handlePlayerBulletHit=(e,t)=>{if(!e.active||!t.active)return;let s=t.getData("damage")||1;this.player.weapon.destroyBullet(t),e.colliderComponent.collideWithEnemyProjectile(s),l.emit(r.ENEMY_HIT)},this.updateLaserCollisions=(e,t)=>{this.player.weapon.isLaserActive()&&(this.laserDamageTimer+=t,this.laserDamageTimer>=this.LASER_DAMAGE_COOLDOWN&&(this.handleLaserCollisions(),this.laserDamageTimer=0))},this.handleLaserCollisions=()=>{let e=this.player.weapon;if(!e.isLaserActive())return;let t=e.laserHitArea,s=e.laserDamagePerTick;this.spawnerManager.getAllSpawners().map(e=>e.phaserGroup).forEach(e=>{e.getChildren().forEach(e=>{e.active&&t.contains(e.x,e.y)&&(e.colliderComponent.collideWithEnemyProjectile(s),this.eventBus.emit(r.ENEMY_HIT))})})},this.handleHomingBulletHit=(e,t)=>{var s,i;if(!(null===(i=this.scene)||void 0===i?void 0:null===(s=i.scene)||void 0===s?void 0:s.isActive())||!this.currentHomingGroup||!e.active||!t.active)return;let n=t.getData("damage")||1;t.disableBody(!0,!0),e.colliderComponent.collideWithEnemyProjectile(n),this.eventBus.emit(r.ENEMY_HIT)},this.scene=e,this.player=t,this.spawnerManager=s,this.eventBus=i,this.currentHomingGroup=this.player.weapon.getHomingBulletGroup(),this.setupEventListeners()}}class W{static getSpawnPositions(e,t,s){switch(e){case"random":return this.getRandomPositions(t,s);case"line":return this.getLinePositions(t,s);case"direct":return this.getDirectPositions(t,s);case"spiral":return this.getSpiralPositions(t,s);case"circle":return this.getCirclePositions(t,s);case"wave":return this.getWavePositions(t,s);default:return console.warn("Unknown pattern type: ".concat(e,", using random")),this.getRandomPositions({minX:0,maxX:800,minY:-50,maxY:-20},s)}}static getRandomPositions(e,t){let s=[];for(let i=0;i<t;i++)s.push({x:Phaser.Math.Between(e.minX,e.maxX),y:Phaser.Math.Between(e.minY,e.maxY)});return s}static getLinePositions(e,t){let s=[],i=e.startX,n=e.startY;for(let a=0;a<t;a++)s.push({x:i,y:n}),i+=e.stepX,n+=e.stepY;return s}static getDirectPositions(e,t){return e.positions.slice(0,t)}static getSpiralPositions(e,t){let s=[],i=e.initialRadius||0,n=e.initialAngle||0;for(let a=0;a<t;a++)s.push({x:e.centerX+Math.cos(n)*i,y:e.centerY+Math.sin(n)*i}),i+=e.radiusStep,n+=e.angleStep;return s}static getCirclePositions(e,t){let s=[],i=(e.fullCircle?2*Math.PI:Math.PI)/t,n=e.startAngle||0;for(let a=0;a<t;a++)s.push({x:e.centerX+Math.cos(n)*e.radius,y:e.centerY+Math.sin(n)*e.radius}),n+=i;return s}static getWavePositions(e,t){let s=[],i=e.startX,n=e.startY;for(let a=0;a<t;a++)s.push({x:i,y:n}),"horizontal"===e.direction?(i+=e.wavelength,n=e.startY+Math.sin(.5*a)*e.amplitude):(n+=e.wavelength,i=e.startX+Math.sin(.5*a)*e.amplitude);return s}}class V{setupEventListeners(){this.eventBus.on(r.START_SPAWNER,this.handleStartSpawner,this),this.eventBus.on(r.STOP_ALL_SPAWNERS,this.stopSpawning,this),this.eventBus.on(r.GAME_OVER,this.handlePause,this),this.eventBus.on(r.PAUSE_GAME,this.handlePause,this),this.eventBus.on(r.RESUME_GAME,this.handleResume,this),this.eventBus.on(r.RESET_ALL_SPAWNERS,this.resetSpawner,this)}handleStartSpawner(e){e.enemyType===this.enemyClass.enemyType&&(this.activeConfig=e,this.spawnCounter=0,this.startSpawning())}startSpawning(){var e,t;this.stopSpawning(),this.isActive=!0,this.spawnTimer=this.scene.time.addEvent({delay:null!==(t=null===(e=this.activeConfig)||void 0===e?void 0:e.interval)&&void 0!==t?t:2e3,callback:this.spawnEnemy,callbackScope:this,loop:!0}),this.spawnEnemy()}spawnEnemy(){if(!this.isActive||!this.activeConfig)return;let e=this.activeConfig.groupSize,t=this.activeConfig.count?this.activeConfig.count-this.spawnCounter:1/0;if(t<=0){this.stopSpawning();return}for(let s of W.getSpawnPositions(this.activeConfig.patternType,this.activeConfig.patternParams.params,Math.min(e,t))){let e=this.group.get(s.x,s.y);e?e.reset():(e=new this.enemyClass(this.scene,s.x,s.y),this.group.add(e),e.init(this.eventBus)),this.spawnCounter++}this.activeConfig.count&&this.spawnCounter>=this.activeConfig.count&&this.stopSpawning()}resetSpawner(){this.stopSpawning(),this.spawnCounter=0,this.activeConfig=void 0}cleanupOffscreenEnemies(){let e=this.scene.physics.world.bounds;this.group.getChildren().forEach(t=>{(t.y>e.height+100||t.y<-100||t.x<-100||t.x>e.width+100)&&t.destroy()})}stopSpawning(){this.spawnTimer&&(this.spawnTimer.destroy(),this.spawnTimer=void 0),this.isActive=!1}handlePause(){this.spawnTimer&&(this.spawnTimer.paused=!0)}handleResume(){this.spawnTimer&&(this.spawnTimer.paused=!1)}cleanup(){var e;this.stopSpawning(),this.eventBus.off(r.START_SPAWNER,this.handleStartSpawner,this),this.eventBus.off(r.STOP_ALL_SPAWNERS,this.stopSpawning,this),this.eventBus.off(r.GAME_OVER,this.stopSpawning,this),this.eventBus.off(r.PAUSE_GAME,this.handlePause,this),this.eventBus.off(r.RESUME_GAME,this.handleResume,this),null===(e=this.cleanupTimer)||void 0===e||e.destroy()}get phaserGroup(){return this.group}constructor(e,t,s){this.spawnCounter=0,this.isActive=!1,this.enemyClass=t,this.scene=e,this.eventBus=s,this.group=this.scene.physics.add.group({classType:t,runChildUpdate:!0,createCallback:e=>{e.init(s)}}),this.setupEventListeners(),this.cleanupTimer=this.scene.time.addEvent({delay:1e3,callback:this.cleanupOffscreenEnemies,callbackScope:this,loop:!0})}}class z{registerSpawner(e,t){let s=new V(this.scene,t,this.eventBus);return this.spawners.set(e,s),s}getSpawner(e){return this.spawners.get(e)}getAllSpawners(){return Array.from(this.spawners.values())}cleanup(){this.spawners.forEach(e=>e.cleanup()),this.spawners.clear()}constructor(e,t){this.spawners=new Map,this.scene=e,this.eventBus=t}}class Y{static createBombItem(e,t,s){let i=e.add.graphics();return i.fillStyle(65280,1),i.lineStyle(3,16777215,1),this.drawStar(i,t,s,5,16,8),i}static createHealthItem(e,t,s){let i=e.add.graphics();return i.fillStyle(16711680,1),i.lineStyle(3,16777215,1),this.drawStar(i,t,s,5,16,8),i}static createPowerItem(e,t,s){let i=e.add.graphics();return i.fillStyle(16711680,1),i.fillRect(-8,-8,16,16),i.lineStyle(3,16777215,1),i.strokeRect(-8,-8,16,16),i}static createScoreItem(e,t,s){let i=e.add.graphics();return i.fillStyle(255,1),i.fillRect(-8,-8,16,16),i.lineStyle(3,16777215,1),i.strokeRect(-8,-8,16,16),i}static createBombIcon(e,t,s){let i=e.add.graphics();return i.fillStyle(65280,1),i.lineStyle(2,16777215,1),this.drawStar(i,t,s,5,10,5),i}static drawStar(e,t,s,i,n,a){let o=Math.PI/i,r=Math.PI/2*3;e.beginPath(),e.moveTo(t,s-n);for(let h=0;h<i;h++){let i=t+Math.cos(r)*n,h=s+Math.sin(r)*n;e.lineTo(i,h);let l=t+Math.cos(r+=o)*a,c=s+Math.sin(r)*a;e.lineTo(l,c),r+=o}e.lineTo(t,s-n),e.closePath(),e.fillPath(),e.strokePath()}}class K extends o().GameObjects.Container{createBombIcons(){this.bombIcons.forEach(e=>e.destroy()),this.bombIcons=[],this.removeAll(!0);for(let e=0;e<I.count;e++){let t=Y.createBombIcon(this.scene,25*e+10,10);this.add(t),this.bombIcons.push(t)}}setupEventListeners(){this.eventBus.on(r.BOMB_COUNT_CHANGED,e=>{this.updateBombIcons(e)})}updateBombIcons(e){for(;this.bombIcons.length>e;){let e=this.bombIcons.pop();null==e||e.destroy()}for(;this.bombIcons.length<e;){let e=this.bombIcons.length,t=Y.createBombIcon(this.scene,25*e+10,10);this.add(t),this.bombIcons.push(t)}}destroy(e){this.eventBus.off(r.BOMB_COUNT_CHANGED),this.bombIcons.forEach(e=>e.destroy()),super.destroy(e)}constructor(e,t){super(e,5,e.scale.height-60),this.bombIcons=[],this.eventBus=t,e.add.existing(this),this.createBombIcons(),this.setupEventListeners()}}class U extends o().GameObjects.Container{createDisplay(){this.weaponTypeText=this.scene.add.text(0,0,"W",{fontFamily:"Arial",fontSize:"24px",color:"#ffffff"}).setOrigin(.5,0),this.powerText=this.scene.add.text(20,0,"0.00",{fontFamily:"Arial",fontSize:"24px",color:"#ffffff"}).setOrigin(0,0),this.add([this.weaponTypeText,this.powerText]);let e=b.loadSettings();this.updateWeaponType(this.mapWeaponType(e.weaponType))}mapWeaponType(e){switch(e){case"wide":return 1;case"laser":return 2;case"rockets":return 3}}setupEventListeners(){this.eventBus.on(r.WEAPON_CHANGED,e=>{this.updateWeaponType(e.weaponType)}),this.eventBus.on(r.POWER_CHANGED,e=>{this.updatePower(e)})}updateWeaponType(e){let t="W";switch(e){case 2:t="L";break;case 3:t="R"}this.weaponTypeText.setText(t)}updatePower(e){let t=(e/100).toFixed(2);this.powerText.setText(t)}destroy(e){this.eventBus.off(r.WEAPON_CHANGED),this.eventBus.off(r.POWER_CHANGED),super.destroy(e)}constructor(e,t){super(e,e.scale.width-80,e.scale.height-60),this.eventBus=t,e.add.existing(this),this.createDisplay(),this.setupEventListeners()}}class j extends Phaser.GameObjects.Text{update(){let e=Date.now(),t=e-this.lastUpdateTime;this.lastUpdateTime=e,t>0&&(this.fpsValues.push(Math.round(1e3/t)),this.fpsValues.length>10&&this.fpsValues.shift(),this.avgFPS=Math.round(this.fpsValues.reduce((e,t)=>e+t,0)/this.fpsValues.length),this.setText("FPS: ".concat(this.avgFPS)))}constructor(e,t,s){super(e,t,s,"",{fontFamily:"Arial",fontSize:"12px",color:"#ffffff",padding:{x:2,y:2}}),this.lastUpdateTime=0,this.fpsValues=[],this.avgFPS=0,e.add.existing(this),this.setOrigin(1,1).setDepth(1e3).setAlpha(.7),this.lastUpdateTime=Date.now()}}let X={SCORE:{texture:"score_item",dropChance:.3,minDropInterval:3,guaranteedDropEvery:15},POWER:{texture:"power_item",dropChance:.15,minDropInterval:5,guaranteedDropEvery:20},HEALTH:{texture:"health_item",dropChance:.1,minDropInterval:8,guaranteedDropEvery:30},BOMB:{texture:"bomb_item",dropChance:.05,minDropInterval:10,guaranteedDropEvery:40}};class J extends o().Physics.Arcade.Sprite{init(e){this.eventBus=e,this.scene.add.existing(this.graphics)}update(){this.graphics.setPosition(this.x,this.y);let e=this.body;e.velocity.y!==this.velocityY&&e.setVelocityY(this.velocityY)}destroy(e){this.graphics.destroy(),super.destroy(e)}constructor(e,t,s){super(e,t,s,""),this.velocityY=200,this.graphics=this.createGraphics(),this.graphics.setPosition(t,s),e.physics.add.existing(this);let i=this.body;i.setSize(this.getColliderWidth(),this.getColliderHeight()),i.setOffset(-this.getColliderWidth()/2,-this.getColliderHeight()/2),i.setVelocity(0,this.velocityY),i.setAllowGravity(!1),i.setCollideWorldBounds(!1),this.setDepth(4)}}class q extends J{createGraphics(){return Y.createScoreItem(this.scene,0,0)}getColliderWidth(){return 16}getColliderHeight(){return 16}onCollect(e){this.eventBus.emit(r.ADD_SCORE,this.scoreValue),this.destroy()}constructor(...e){super(...e),this.scoreValue=100}}class Z extends J{createGraphics(){return Y.createPowerItem(this.scene,0,0)}getColliderWidth(){return 16}getColliderHeight(){return 16}onCollect(e){this.eventBus.emit(r.ADD_POWER,this.powerValue),this.destroy()}constructor(...e){super(...e),this.powerValue=5}}class $ extends J{createGraphics(){return Y.createHealthItem(this.scene,0,0)}getColliderWidth(){return 32}getColliderHeight(){return 32}onCollect(e){this.eventBus.emit(r.ADD_LIFE,this.healthValue),this.destroy()}constructor(...e){super(...e),this.healthValue=1}}class Q extends J{createGraphics(){return Y.createBombItem(this.scene,0,0)}getColliderWidth(){return 32}getColliderHeight(){return 32}onCollect(e){this.eventBus.emit(r.ADD_BOMB,this.bombValue),this.destroy()}constructor(...e){super(...e),this.bombValue=1}}class ee{setupEventListeners(){this.eventBus.on("ENEMY_DESTROYED",this.handleEnemyDestroyed,this),this.eventBus.on("BOSS_PHASE_CHANGE",this.handleBossPhaseChange,this),this.eventBus.on(r.BOSS_DEFEATED,this.handleBossPhaseChange,this)}update(){this.itemsGroup&&this.itemsGroup.getChildren().forEach(e=>{if(e.active){if(e.y>this.scene.scale.height+50){e.destroy();return}this.player.canPickup(e)&&(e.onCollect(this.player),e.destroy())}})}clearAllItems(){var e,t;!this.itemsGroup||(null===(e=this.itemsGroup.scene)||void 0===e?void 0:e.scene.isPaused())||((null===(t=this.itemsGroup)||void 0===t?void 0:t.getChildren().slice()).forEach(e=>{e instanceof o().GameObjects.GameObject&&e.destroy(!0)}),this.itemsGroup.clear(!0,!0))}tryDropSpecificItems(e){e.dropConfig.items.forEach(t=>{o().Math.FloatBetween(0,1)<=t.chance&&this.dropItem(t.type,e.x,e.y)})}tryDropGlobalItems(e,t){for(let[s,i]of Object.entries(X))if(this.enemyKillCount-this.lastDropCount>=i.guaranteedDropEvery){this.dropItem(s,e,t),this.lastDropCount=this.enemyKillCount;return}for(let[s,i]of Object.entries(X))if(this.enemyKillCount-this.lastDropCount>=i.minDropInterval&&o().Math.FloatBetween(0,1)<=i.dropChance){this.dropItem(s,e,t),this.lastDropCount=this.enemyKillCount;break}}dropBossPhaseItems(e,t){var s;let i=e.x,n=e.y-100,a=0;null===(s=t.dropItems)||void 0===s||s.forEach(e=>{var s;for(let t=0;t<e.count;t++){let s=t/e.count*Math.PI*2+a,o=i+Math.cos(s)*e.spread,r=n+Math.sin(s)*e.spread;this.dropItem(e.type,o,r)}a+=Math.PI/((null===(s=t.dropItems)||void 0===s?void 0:s.length)||1)})}dropDefaultBossItems(e){let t=e.x,s=e.y-100;[{type:"SCORE",count:5,angleOffset:0},{type:"POWER",count:5,angleOffset:Math.PI/5}].forEach(e=>{for(let i=0;i<e.count;i++){let n=i/e.count*Math.PI*2+e.angleOffset,a=t+60*Math.cos(n),o=s+60*Math.sin(n);this.dropItem(e.type,a,o)}})}dropItem(e,t,s){let i;switch(e){case"SCORE":i=new q(this.scene,t,s);break;case"POWER":i=new Z(this.scene,t,s);break;case"HEALTH":i=new $(this.scene,t,s);break;case"BOMB":i=new Q(this.scene,t,s);break;default:return}i.init(this.eventBus),this.itemsGroup.add(i)}cleanup(){this.clearAllItems(),this.scene.events.off(o().Scenes.Events.UPDATE,this.update,this),this.eventBus.off(r.ENEMY_DESTROYED,this.handleEnemyDestroyed,this),this.eventBus.off(r.BOSS_PHASE_CHANGE,this.handleBossPhaseChange,this),this.eventBus.off(r.BOSS_DEFEATED,this.handleBossPhaseChange,this),this.itemsGroup&&(this.itemsGroup.destroy(),this.itemsGroup=null)}constructor(e,t,s){this.enemyKillCount=0,this.lastDropCount=0,this.handleEnemyDestroyed=e=>{if(this.enemyKillCount++,e.dropConfig){this.tryDropSpecificItems(e);return}this.tryDropGlobalItems(e.x,e.y)},this.handleBossPhaseChange=e=>{let t=e.currentPhaseIndex-1,s=e._phases[t];this.clearAllItems(),s.dropItems?this.dropBossPhaseItems(e,s):this.dropDefaultBossItems(e)},this.scene=e,this.eventBus=t,this.player=s,this.itemsGroup=this.scene.physics.add.group({classType:o().GameObjects.Sprite,maxSize:40,runChildUpdate:!0}),this.setupEventListeners(),this.scene.events.on(o().Scenes.Events.UPDATE,this.update,this)}}class et extends m{setMovementAngle(e){this._movementAngle=e,this.updateMovement()}setShootTarget(e,t){this._shootAngle=e,this._shouldShoot=t}update(e,t){this._shouldShoot?this.pressPrimaryAction():this.releasePrimaryAction()}updateMovement(){this.resetMovement();let e=Math.cos(this._movementAngle),t=Math.sin(this._movementAngle);e>0?this.pressRight():e<0&&this.pressLeft(),t>0?this.pressDown():t<0&&this.pressUp()}resetMovement(){this.releaseUp(),this.releaseDown(),this.releaseLeft(),this.releaseRight()}constructor(){super(),this._movementAngle=Math.PI/2,this._shouldShoot=!1,this._shootAngle=0,this.updateMovement()}}class es extends M{init(e){super.init(e),this._inputComponent=new et,this._horizontalMovement=new g(this,this._inputComponent,180),this._verticalMovement=new y(this,this._inputComponent,180),this._bulletSpawner=new D(this.scene,this,"red_rice",100),this._dropConfig={items:[{type:"POWER",chance:.4},{type:"SCORE",chance:.4}]},this.setWaveParams(),e.emit(r.ENEMY_INIT,this)}setWaveParams(){var e;this._waveCenterX=240,this._waveCenterY=340,this._isMovingOut=!1,this._shootCounter=0,null===(e=this._shootingEvent)||void 0===e||e.destroy()}initSprites(){this._shipSprite=this.scene.add.sprite(0,0,"fighter",0),this._engineSprite=this.scene.add.sprite(0,0,"fighter_engine").setFlipY(!0).play("fighter_engine"),this.add([this._engineSprite,this._shipSprite])}getInitialHealth(){return 250}customUpdate(e,t){this.updateMovement(e),this._inputComponent.update(e,t),this._horizontalMovement.update(),this._verticalMovement.update(),this._isMovingOut&&this.checkBounds()}updateMovement(e){if(!this._isMovingOut){if(o().Math.Distance.Between(this.x,this.y,this._waveCenterX,this._waveCenterY)>this._stopDistance){let e=o().Math.Angle.Between(this.x,this.y,this._waveCenterX,this._waveCenterY);this._inputComponent.setMovementAngle(e)}else 0===this._shootCounter&&(this._inputComponent.resetMovement(),this.startShootingBehavior(e))}}startShootingBehavior(e){this.updateShootingTarget(e),this._shootingEvent=this.scene.time.addEvent({delay:250,callback:()=>{this.active&&!this._isMovingOut&&this.fireAtAngle(this._currentTargetAngle)},callbackScope:this,loop:!0})}updateShootingTarget(e){let t=this.getPlayer();t&&(this._currentTargetAngle=o().Math.Angle.Between(this.x,this.y,t.x,t.y)),this._inputComponent.setShootTarget(this._currentTargetAngle,!0),this._shootCounter++,this._shootCounter>=this._maxShoots?this.startMovingOut():this.scene.time.delayedCall(this._shootInterval,()=>{this.updateShootingTarget(e)})}startMovingOut(){var e;this._isMovingOut=!0,null===(e=this._shootingEvent)||void 0===e||e.destroy();let t=o().Math.Angle.Between(this._waveCenterX,this._waveCenterY,this.x,this.y);this._inputComponent.setMovementAngle(t),this._inputComponent.setShootTarget(0,!1)}fireAtAngle(e){if(!this._bulletSpawner)return;let t=new(o()).Math.Vector2(Math.cos(e),Math.sin(e)),s=new(o()).Math.Vector2(Math.cos(e-o().Math.DegToRad(20)),Math.sin(e-o().Math.DegToRad(20))),i=new(o()).Math.Vector2(Math.cos(e+o().Math.DegToRad(20)),Math.sin(e+o().Math.DegToRad(20)));this._bulletSpawner.spawn({directions:[t,s,i],speed:350,lifespan:4e3,size:{width:6,height:10},flipY:!0,scale:1.1,spawnPosition:{x:this.x,y:this.y+10}}),this._eventBusComponent.emit(r.SHIP_SHOOT)}getPlayer(){try{return this.scene.registry.get("player")}catch(e){return null}}checkBounds(){let{width:e,height:t}=this.scene.scale;(this.x<-100||this.x>e+100||this.y<-100||this.y>t+100)&&this.destroy()}destroy(e){var t;null===(t=this._shootingEvent)||void 0===t||t.destroy(),this._bulletSpawner&&this._bulletSpawner.cleanup(),this._engineSprite.destroy(e),super.destroy(e)}get shipAssetKey(){return"fighter"}get shipDestroyedAnimationKey(){return"fighter_destroy"}constructor(e,t,s){super(e,t,s),this._waveCenterX=0,this._waveCenterY=0,this._stopDistance=150,this._shootInterval=2e3,this._shootCounter=0,this._maxShoots=25,this._currentTargetAngle=0,this._isMovingOut=!1,this.initSprites()}}es.enemyType="circular_fighter";class ei{getDefaultConfig(){return{bgMusic:{bg:{baseVolume:1,loop:!0}},sfx:{explosion:{baseVolume:1,instances:3,overlap:!1},hit:{baseVolume:1,instances:1,overlap:!1},shot1:{baseVolume:1,instances:3,overlap:!0}}}}init(){this.preloadSounds(),this.setupEventListeners(),this.applyCurrentVolumes()}applyCurrentVolumes(){if(this.currentMusic){let e=this.config.bgMusic[this.currentMusic.key];e&&this.currentMusic.setVolume(e.baseVolume*this.currentSettings.musicVolume)}this.soundPools.forEach((e,t)=>{let s=this.config.sfx[t];s&&e.forEach(e=>{e.setVolume(s.baseVolume*this.currentSettings.sfxVolume)})})}preloadSounds(){Object.keys(this.config.bgMusic).forEach(e=>{let t=this.config.bgMusic[e];this.scene.sound.add(e,{...t,volume:t.baseVolume*this.currentSettings.musicVolume})}),Object.entries(this.config.sfx).forEach(e=>{let[t,s]=e,i=[];for(let e=0;e<(s.instances||3);e++){let e=this.scene.sound.add(t,{...s,volume:s.baseVolume*this.currentSettings.sfxVolume});i.push(e)}this.soundPools.set(t,i)})}setupEventListeners(){this.eventBus.on(r.ENEMY_DESTROYED,()=>this.playFromPool("explosion")),this.eventBus.on(r.PLAYER_DESTROYED,()=>this.playFromPool("explosion")),this.eventBus.on(r.SHIP_HIT,()=>this.playFromPool("hit")),this.eventBus.on(r.SHIP_SHOOT,()=>this.playFromPool("shot1")),this.eventBus.on(r.SETTINGS_CHANGED,e=>{this.currentSettings=e,this.applyCurrentVolumes()})}playFromPool(e){let t=this.soundPools.get(e),s=this.config.sfx[e];if(!t||!s)return!1;if(s.overlap){let s=t.find(e=>!e.isPlaying);if(s)return this.setSoundVolume(s,e),s.play(),!0}let i=t[0];return i.isPlaying&&!s.overlap&&i.stop(),this.setSoundVolume(i,e),i.play(),!0}setSoundVolume(e,t){let s=this.config.sfx[t];s&&e.setVolume(s.baseVolume*this.currentSettings.sfxVolume)}playMusic(e){let t=this.config.bgMusic[e];if(!t){console.error("Music ".concat(e," not configured"));return}this.stopMusic(),this.currentMusic=this.scene.sound.add(e,{...t,volume:t.baseVolume*this.currentSettings.musicVolume}),this.currentMusic.play()}stopMusic(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.currentMusic&&(e>0?this.scene.tweens.add({targets:this.currentMusic,volume:0,duration:e,onComplete:()=>{var e,t;null===(e=this.currentMusic)||void 0===e||e.stop(),null===(t=this.currentMusic)||void 0===t||t.destroy(),this.currentMusic=null}}):(this.currentMusic.stop(),this.currentMusic.destroy(),this.currentMusic=null))}changeMusic(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.stopMusic(t),this.scene.time.delayedCall(t+100,()=>{this.playMusic(e)})}destroy(){this.stopMusic(),this.soundPools.forEach(e=>{e.forEach(e=>e.destroy())}),this.soundPools.clear(),this.eventBus.off(r.ENEMY_DESTROYED),this.eventBus.off(r.PLAYER_DESTROYED),this.eventBus.off(r.SHIP_HIT),this.eventBus.off(r.SHIP_SHOOT),this.eventBus.off(r.SETTINGS_CHANGED)}constructor(e,t){this.soundPools=new Map,this.currentMusic=null,this.scene=e,this.eventBus=t,this.currentSettings=b.loadSettings(),this.config=this.getDefaultConfig(),this.init()}}class en extends o().Scene{create(){var e;this.cleanup(),this.currentSettings=b.loadSettings(),this.isPaused=!1,this.time.paused=!1,this.physics.world.resume(),this.initGameSystems(),this.initUI(),this.createBackgrounds(),null===(e=this.input.keyboard)||void 0===e||e.removeKey(o().Input.Keyboard.KeyCodes.ESC),this.pauseKey=this.input.keyboard.addKey(o().Input.Keyboard.KeyCodes.ESC),this.pauseKey.reset();let t=this.createLevels();this.levelManager=new L(this,t),this.setupEventListeners(),this.time.delayedCall(1e3,()=>{l.emit(r.PLAYER_READY)}),this.currentLevel=0,l.emit("current-scene-ready",this),l.emit(r.POWER_CHANGED,0)}createLevels(){return v}createBackgrounds(){this.audioManager.playMusic("bg"),this.backgrounds.forEach(e=>e.destroy()),this.backgrounds=[],[{key:"bg1",speed:.5,alpha:.7,scale:1.25},{key:"bg2",speed:1,alpha:.7,scale:1.25},{key:"bg3",speed:1.5,alpha:.7,scale:1.25}].forEach((e,t)=>{let s=this.add.tileSprite(0,0,this.scale.width,this.scale.height,e.key);s.setOrigin(0,0).setAlpha(e.alpha).setScale(e.scale).setDepth(-10+t),this.backgrounds.push(s)})}setupEventListeners(){l.on(r.LEVEL_COMPLETE,this.handleLevelComplete,this),l.on(r.PLAYER_READY,this.startLevel,this),l.on(r.GAME_OVER,this.handleGameOver,this),l.on(r.RESTART_GAME,this.restartGame,this),l.on(r.CONTINUE_GAME,this.continueGame,this),l.on(r.CLEANUP_GAME,this.cleanup,this),l.on(r.MAIM_MENU_FROM_GAME_OVER,this.returnToMainMenu,this)}initGameSystems(){this.player=new C(this,l),this.registry.set("player",this.player),this.spawnerManager=new z(this,l),this.initializeSpawners(),new A(this,l),this.itemManager=new ee(this,l,this.player),this.audioManager=new ei(this,l)}prepareNextLevel(e){this.cleanupLevel(),this.initializeSpawners(),this.currentLevel=e,this.startLevel()}cleanupLevel(){var e;this.spawnerManager.getAllSpawners().forEach(e=>e.cleanup()),null===(e=this.itemManager)||void 0===e||e.clearAllItems()}initializeSpawners(){this.cleanupLevel(),this.spawnerManager.cleanup(),this.collisionManager&&this.collisionManager.cleanup(),[{type:"scout",class:F},{type:"fighter",class:G},{type:"circular_fighter",class:es}].forEach(e=>{let{type:t,class:s}=e;this.spawnerManager.registerSpawner(t,s)}),this.collisionManager=new N(this,this.player,this.spawnerManager,l),this.collisionManager.setupBaseCollisions()}initUI(){this.scoreSystem=new x(this,l),this.livesSystem=new B(this,l),this.bombCounter=new K(this,l),this.weaponDisplay=new U(this,l),this.currentSettings.showFPS&&(this.fpsDisplay=new j(this,470,630))}update(){!this.scene.isActive()||this.isGameplayBlocked()||(this.backgrounds.forEach((e,t)=>{let s=[.5,1,1.5][t]||1;e.tilePositionY-=s}),o().Input.Keyboard.JustDown(this.pauseKey)&&this.togglePause(),this.currentSettings.showFPS&&this.fpsDisplay.update(),this.registry.set("player",this.player))}isGameplayBlocked(){return this.scene.isActive("LevelComplete")||this.scene.isActive("Victory")||this.scene.isActive("PauseMenu")}togglePause(){this.isGameplayBlocked()||(this.isPaused=!this.isPaused,this.isPaused?this.pauseGame():this.resumeGame())}pauseGame(){this.physics.world.pause(),this.time.paused=!0,this.scene.launch("PauseMenu",{onResume:()=>this.resumeGame(),onRestart:()=>this.restartGame(),onMainMenu:()=>this.returnToMainMenu()}),this.scene.pause()}resumeGame(){this.physics.world.resume(),this.time.paused=!1,this.scene.isActive("PauseMenu")&&this.scene.stop("PauseMenu"),this.scene.resume(),this.isPaused=!1}restartGame(){this.scene.stop("PauseMenu"),this.scene.stop("GameOver"),this.cleanup(),this.scene.restart()}returnToMainMenu(){this.cleanup(),this.scene.stop("PauseMenu"),this.scene.stop("GameScene"),this.scene.start("MainMenu")}continueGame(){this.livesSystem&&this.livesSystem.resetLives(),this.continueCount<9&&this.continueCount++,this.scoreSystem&&this.scoreSystem.resetScore(this.continueCount),l.emit(r.PLAYER_SPAWN),l.emit(r.RESUME_GAME),this.cameras.main.fadeIn(300),this.physics.world.resume(),this.time.paused=!1,this.scene.isActive("GameOver")&&this.scene.stop("GameOver"),this.scene.resume(),this.isPaused=!1}cleanup(){var e,t,s,i,n,a,o,h,c,u;this.sound.stopAll(),null===(e=this.audioManager)||void 0===e||e.destroy(),null===(t=this.itemManager)||void 0===t||t.clearAllItems(),null===(s=this.itemManager)||void 0===s||s.cleanup(),null===(i=this.levelManager)||void 0===i||i.cleanup(),null===(n=this.collisionManager)||void 0===n||n.cleanup(),null===(a=this.spawnerManager)||void 0===a||a.cleanup(),this.player&&(null===(u=this.player)||void 0===u||null===(c=u.weapon)||void 0===c||c.cleanup(),this.player.cleanup()),null===(o=this.bombCounter)||void 0===o||o.destroy(),null===(h=this.weaponDisplay)||void 0===h||h.destroy(),this.physics.world.shutdown(),this.scoreSystem&&this.scoreSystem.destroy(),this.livesSystem&&this.livesSystem.destroy(),this.backgrounds.forEach(e=>e.destroy()),this.backgrounds=[],l.off(r.LEVEL_COMPLETE,this.handleLevelComplete,this),l.off(r.PLAYER_READY,this.startLevel,this),l.off(r.GAME_OVER,this.handleGameOver,this),l.off(r.RESTART_GAME,this.restartGame,this),l.off(r.CONTINUE_GAME,this.continueGame,this)}constructor(){super({key:"GameScene"}),this.isPaused=!1,this.backgrounds=[],this.continueCount=0,this.startLevel=()=>{console.log("[GameScene] Starting level ".concat(this.currentLevel+1)),this.registry.set("currentLevel",this.currentLevel+1),this.levelManager.startLevel(this.currentLevel)},this.handleLevelComplete=e=>{e.level+1<this.levelManager.levelsCount?(this.time.delayedCall(5e3,()=>{this.scene.launch("LevelComplete",{level:e.level,lives:this.livesSystem.livesCount})}),this.time.delayedCall(9e3,()=>{this.prepareNextLevel(e.level+1)})):(l.emit(r.GAME_COMPLETE),this.scene.launch("Victory",{score:this.registry.get("score"),lives:this.livesSystem.livesCount}))},this.handleGameOver=()=>{this.time.delayedCall(500,()=>{this.physics.world.pause(),this.time.paused=!0,this.scene.launch("GameOver",{score:this.registry.get("score")}),this.scene.pause()})}}}class ea extends m{update(){this.keys.up.isDown?this.pressUp():this.releaseUp(),this.keys.down.isDown?this.pressDown():this.releaseDown(),this.keys.left.isDown?this.pressLeft():this.releaseLeft(),this.keys.right.isDown?this.pressRight():this.releaseRight(),this.keys.primary.some(e=>o().Input.Keyboard.JustDown(e))?this.pressPrimaryAction():this.releasePrimaryAction(),this.keys.secondary.some(e=>o().Input.Keyboard.JustDown(e))?this.pressSecondaryAction():this.releaseSecondaryAction(),this.keys.third.some(e=>o().Input.Keyboard.JustDown(e))?this.pressThirdAction():this.releaseThirdAction()}cleanup(){let e=this.scene.input.keyboard;e&&(this.keys.primary.forEach(t=>e.removeKey(t.keyCode)),this.keys.secondary.forEach(t=>e.removeKey(t.keyCode)),this.keys.third.forEach(t=>e.removeKey(t.keyCode)))}constructor(e){super(),this.scene=e;let t=e.input.keyboard;this.keys={up:t.addKey(o().Input.Keyboard.KeyCodes.UP),down:t.addKey(o().Input.Keyboard.KeyCodes.DOWN),left:t.addKey(o().Input.Keyboard.KeyCodes.LEFT),right:t.addKey(o().Input.Keyboard.KeyCodes.RIGHT),primary:[t.addKey(o().Input.Keyboard.KeyCodes.ENTER),t.addKey(o().Input.Keyboard.KeyCodes.SPACE),t.addKey(o().Input.Keyboard.KeyCodes.Z)],secondary:[t.addKey(o().Input.Keyboard.KeyCodes.ESC),t.addKey(o().Input.Keyboard.KeyCodes.X)],third:[t.addKey(o().Input.Keyboard.KeyCodes.R)]}}}class eo extends o().Scene{init(e){this.score=e.score||0,this.selectedItemIndex=0,this.lastInputTime=0}create(){this.cameras.main.fadeIn(500,0,0,0),this.createBackground(),this.createTitle(),this.createScoreDisplay(),this.createMenuItems(),this.setupInput(),this.selectMenuItem(0),l.emit("current-scene-ready",this)}createBackground(){this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,0,.7).setOrigin(0)}createTitle(){this.add.text(this.cameras.main.width/2,100,"GAME OVER",{fontSize:"48px",color:"#ff0000",fontFamily:"Arial",stroke:"#000000",strokeThickness:4}).setOrigin(.5)}createScoreDisplay(){this.add.text(this.cameras.main.width/2,200,"FINAL SCORE: ".concat(this.score),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5)}createMenuItems(){this.menuItems=[this.createMenuItem(300,"CONTINUE","#00ff00",()=>{l.emit("continue-game"),this.scene.stop()}),this.createMenuItem(400,"PLAY AGAIN","#ffffff",()=>{this.sound.stopAll(),this.scene.stop(),l.emit("restart-game")}),this.createMenuItem(500,"SAVE RESULT","#ffffff",()=>{b.isScoreInTop(this.score)?this.scene.launch("InputScene",{score:this.score,level:this.registry.get("currentLevel")||1}):this.showMessage("Score too low for top 10")}),this.createMenuItem(600,"MAIN MENU","#ffffff",()=>{this.sound.stopAll(),this.scene.stop(),l.emit("main-menu-from-game-over")})]}showMessage(e){let t=this.children.getByName("statusMessage");t&&t.destroy();let s=this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,e,{fontFamily:"Arial",fontSize:"28px",color:"#ff0000",backgroundColor:"#333333",padding:{left:20,right:20,top:10,bottom:10},stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(100).setName("statusMessage");s.setAlpha(0),this.tweens.add({targets:s,alpha:1,duration:300,ease:"Linear"}),this.time.delayedCall(2e3,()=>{this.tweens.add({targets:s,alpha:0,duration:500,ease:"Linear",onComplete:()=>s.destroy()})})}createMenuItem(e,t,s,i){let n=this.add.text(this.cameras.main.width/2,e,t,{fontFamily:"Arial",fontSize:"32px",color:s,stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive();return n.on("pointerover",()=>{this.selectedItemIndex=this.menuItems.indexOf(n),this.selectMenuItem(this.selectedItemIndex)}),n.on("pointerout",()=>{n.setColor(s)}),n.on("pointerdown",i),n}setupInput(){this.menuInput=new ea(this),this.input.on("pointermove",e=>{if(!e.isDown)return;let t=this.menuItems.find(t=>t.getBounds().contains(e.x,e.y));t&&(this.selectedItemIndex=this.menuItems.indexOf(t),this.selectMenuItem(this.selectedItemIndex),t.emit("pointerdown"))})}update(e){!this.menuInput||this.isInputSceneActive()||(this.menuInput.update(),this.handleNavigation(e),this.handleSelection(),this.handleThirdAction())}isInputSceneActive(){return this.scene.isActive("InputScene")}handleNavigation(e){!(e-this.lastInputTime<this.inputDelay)&&(this.menuInput.downIsDown?(this.changeSelectedItem(1),this.lastInputTime=e):this.menuInput.upIsDown&&(this.changeSelectedItem(-1),this.lastInputTime=e))}changeSelectedItem(e){this.selectedItemIndex=(this.selectedItemIndex+e+this.menuItems.length)%this.menuItems.length,this.selectMenuItem(this.selectedItemIndex)}handleSelection(){this.menuInput.primaryActionIsDown&&this.menuItems[this.selectedItemIndex].emit("pointerdown")}handleThirdAction(){this.menuInput.thirdActionIsDown&&this.registry.get("onRestart")()}selectMenuItem(e){this.menuItems.forEach((t,s)=>{t.setColor(s===e?"#ff0":"#fff"),t.setScale(s===e?1.1:1)})}shutdown(){var e;let t=this.children.getByName("statusMessage");t&&t.destroy(),null===(e=this.menuInput)||void 0===e||e.cleanup(),this.input.off("pointermove")}constructor(){super("GameOver"),this.menuItems=[],this.selectedItemIndex=0,this.lastInputTime=0,this.inputDelay=200,this.score=0}}class er{static initialize(e,t,s){this.token=e,this.userId=t,this.username=s}static enableSync(){this.syncEnabled=!0}static disableSync(){this.syncEnabled=!1}static isSyncEnabled(){return this.syncEnabled}static getUsername(){return this.username||localStorage.getItem("username")}static get headers(){return{"Content-Type":"application/json",...this.token?{Authorization:"Bearer ".concat(this.token)}:{}}}static async checkConnection(){try{let e=await fetch("/api/game/ping");if(!e.ok)return this.disableSync(),!1;let t=await e.json();if(!0===t.ok)return!0;return this.disableSync(),!1}catch(e){return console.error("Ping fetch error:",e),this.disableSync(),!1}}static isLoggedIn(){return!!(this.token&&this.userId)}static async isDbConnected(){return await this.checkConnection()}static async get(e){if(!this.syncEnabled||!this.token)return null;try{let t=await fetch(e,{headers:this.headers});if(!t.ok)throw Error("GET ".concat(e," failed"));return await t.json()}catch(t){return console.error("".concat(e," fetch error:"),t),this.disableSync(),null}}static async post(e,t){if(!this.syncEnabled||!this.token)return null;try{let s=await fetch(e,{method:"POST",headers:this.headers,body:JSON.stringify(t)});if(!s.ok)throw Error("POST ".concat(e," failed"));return await s.json()}catch(t){return console.error("".concat(e," post error:"),t),null}}static async loadSettings(){try{let e=await fetch("/api/game/settings",{headers:this.headers});if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let t=await e.json();if(t.localMode)return this.disableSync(),null;if("number"!=typeof t.sound_volume||"number"!=typeof t.music_volume||"boolean"!=typeof t.fps||!["wide","laser","rockets"].includes(t.shot_type))throw Error("Invalid settings format received from server");return{musicVolume:t.music_volume,sfxVolume:t.sound_volume,showFPS:t.fps,weaponType:t.shot_type}}catch(e){return console.error("Failed to load settings from server:",e),this.disableSync(),null}}static async saveSettings(e){try{let t=await fetch("/api/game/settings",{method:"POST",headers:this.headers,body:JSON.stringify({sound_volume:e.sfxVolume,music_volume:e.musicVolume,shot_type:e.weaponType,fps:e.showFPS})});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));let s=await t.json();return!0===s.success}catch(e){return console.error("Failed to save settings to server:",e),!1}}static async loadHighScores(){let e=await this.get("/api/game/scores");return e?e.map(e=>({name:e.entry_name,score:e.score,level:e.stage,date:e.date})):null}static async addHighScore(e){let t={entry_name:e.name,stage:e.level,score:e.score},s=await this.post("/api/game/scores",t);return s?s.map(e=>({name:e.entry_name,score:e.score,level:e.stage,date:e.date})):null}static async delete(e){if(!this.syncEnabled||!this.token)return null;try{let t=await fetch(e,{method:"DELETE",headers:this.headers});if(!t.ok)throw Error("DELETE ".concat(e," failed"));return await t.json()}catch(t){return console.error("".concat(e," delete error:"),t),null}}static async clearHighScores(){await this.delete("/api/game/scores")}static async loadGlobalLeaderboard(){try{let e=await fetch("/api/leaderboard/global");if(!e.ok)throw Error("Failed to fetch global leaderboard");return(await e.json()).map(e=>({name:e.entry_name,score:e.score,level:e.stage,date:e.date}))}catch(e){return console.error("Error loading global leaderboard:",e),null}}}er.token=null,er.userId=null,er.username=null,er.syncEnabled="true"===localStorage.getItem("isSyncing");class eh extends o().Scene{async create(){this.selectedItemIndex=this.registry.get("selectedMenuItemIndex")||0,this.add.rectangle(0,0,50,50,0).setOrigin(0).setDepth(1e3),this.createBackground(),this.createTitle(),this.createMenuItems(),this.setupInput(),this.selectMenuItem(this.selectedItemIndex),l.emit("current-scene-ready",this)}createBackground(){this.add.image(0,0,"background").setOrigin(0).setScale(1.25)}createTitle(){this.title=this.add.text(this.cameras.main.width/2,100,"End of Course",{fontFamily:"Arial",fontSize:"48px",color:"#00ffff",stroke:"#000000",strokeThickness:4,shadow:{offsetX:0,offsetY:0,color:"#00ffff",blur:8,stroke:!0,fill:!0}}).setOrigin(.5)}async createMenuItems(){this.menuItems=[this.createMenuItem(200,"Game Start",()=>{this.registry.set("selectedMenuItemIndex",0),this.scene.start("GameScene")}),this.createMenuItem(300,"Records",()=>{this.registry.set("selectedMenuItemIndex",1),this.scene.start("RecordsScene")}),this.createMenuItem(400,"Options",()=>{this.registry.set("selectedMenuItemIndex",2),this.scene.start("OptionsScene")})],await er.checkConnection()&&this.menuItems.push(this.createMenuItem(500,"Leaderboard",()=>{this.registry.set("selectedMenuItemIndex",3),this.scene.start("LeaderboardScene")}))}createMenuItem(e,t,s){let i=this.add.text(this.cameras.main.width/2,e,t,{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive();return i.on("pointerover",()=>{this.selectedItemIndex=this.menuItems.indexOf(i),this.selectMenuItem(this.selectedItemIndex)}),i.on("pointerout",()=>{i.setColor("#ffffff")}),i.on("pointerdown",s),i}setupInput(){this.menuInput=new ea(this),this.input.on("pointermove",e=>{if(!e.isDown)return;let t=this.menuItems.find(t=>t.getBounds().contains(e.x,e.y));t&&(this.selectedItemIndex=this.menuItems.indexOf(t),this.selectMenuItem(this.selectedItemIndex),t.emit("pointerdown"))})}update(e){this.menuInput&&(this.menuInput.update(),this.handleNavigation(e),this.handleSelection(),this.handleSecondaryAction())}handleNavigation(e){!(e-this.lastInputTime<this.inputDelay)&&(this.menuInput.downIsDown?(this.changeSelectedItem(1),this.lastInputTime=e):this.menuInput.upIsDown&&(this.changeSelectedItem(-1),this.lastInputTime=e))}changeSelectedItem(e){this.selectedItemIndex=(this.selectedItemIndex+e+this.menuItems.length)%this.menuItems.length,this.selectMenuItem(this.selectedItemIndex)}handleSelection(){this.menuInput.primaryActionIsDown&&this.menuItems[this.selectedItemIndex].emit("pointerdown")}handleSecondaryAction(){this.menuInput.secondaryActionIsDown&&console.log("Secondary action triggered")}selectMenuItem(e){this.menuItems.forEach((t,s)=>{t.setColor(s===e?"#ff0":"#fff"),t.setScale(s===e?1.1:1)})}shutdown(){this.menuInput.cleanup(),this.input.off("pointermove")}constructor(){super("MainMenu"),this.menuItems=[],this.selectedItemIndex=0,this.lastInputTime=0,this.inputDelay=200}}class el extends o().Scene{init(e){this.selectedItemIndex=0,this.lastInputTime=0,this.registry.set("onResume",e.onResume),this.registry.set("onRestart",e.onRestart),this.registry.set("onMainMenu",e.onMainMenu)}create(){this.createBackground(),this.createTitle(),this.createMenuItems(),this.setupInput(),this.selectMenuItem(0),l.emit("current-scene-ready",this)}createBackground(){this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,0,.7).setOrigin(0)}createTitle(){this.add.text(this.cameras.main.width/2,200,"PAUSE",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff",stroke:"#000000",strokeThickness:4}).setOrigin(.5)}createMenuItems(){this.menuItems=[this.createButton("CONTINUE",300,()=>this.registry.get("onResume")()),this.createButton("RESTART",400,()=>this.registry.get("onRestart")()),this.createButton("MAIN MENU",500,()=>this.registry.get("onMainMenu")())]}createButton(e,t,s){let i=this.add.text(this.cameras.main.width/2,t,e,{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive();return i.on("pointerover",()=>{this.selectedItemIndex=this.menuItems.indexOf(i),this.selectMenuItem(this.selectedItemIndex)}),i.on("pointerout",()=>{i.setColor("#ffffff")}),i.on("pointerdown",s),i}setupInput(){this.menuInput=new ea(this),this.input.on("pointermove",e=>{if(!e.isDown)return;let t=this.menuItems.find(t=>t.getBounds().contains(e.x,e.y));t&&(this.selectedItemIndex=this.menuItems.indexOf(t),this.selectMenuItem(this.selectedItemIndex),t.emit("pointerdown"))})}update(e){this.menuInput&&(this.menuInput.update(),this.handleNavigation(e),this.handleSelection(),this.handleSecondaryAction(),this.handleTrirdAction())}handleNavigation(e){!(e-this.lastInputTime<this.inputDelay)&&(this.menuInput.downIsDown?(this.changeSelectedItem(1),this.lastInputTime=e):this.menuInput.upIsDown&&(this.changeSelectedItem(-1),this.lastInputTime=e))}changeSelectedItem(e){this.selectedItemIndex=(this.selectedItemIndex+e+this.menuItems.length)%this.menuItems.length,this.selectMenuItem(this.selectedItemIndex)}handleSelection(){this.menuInput.primaryActionIsDown&&this.menuItems[this.selectedItemIndex].emit("pointerdown")}handleSecondaryAction(){this.menuInput.secondaryActionIsDown&&this.registry.get("onResume")()}handleTrirdAction(){this.menuInput.thirdActionIsDown&&this.registry.get("onRestart")()}selectMenuItem(e){this.menuItems.forEach((t,s)=>{t.setColor(s===e?"#ff0":"#fff"),t.setScale(s===e?1.1:1)})}shutdown(){this.menuInput.cleanup(),this.registry.remove("onResume"),this.registry.remove("onRestart"),this.registry.remove("onMainMenu"),this.input.off("pointermove")}constructor(){super("PauseMenu"),this.menuItems=[],this.selectedItemIndex=0,this.lastInputTime=0,this.inputDelay=200}}class ec extends o().Scene{preload(){this.createLoadingVisuals(),this.load.pack("asset_pack",(0,c.A)("data/assets.json")),this.load.on("progress",this.updateLoadingBar,this),this.load.on("complete",this.onLoadComplete,this)}create(){l.emit("current-scene-ready",this),this.createAnimations()}createLoadingVisuals(){let{width:e,height:t}=this.cameras.main,s=.6*e;this.loadingBar=this.add.graphics().fillStyle(4473924,1).fillRect((e-s)/2,t/2-20,s,20),this.progressBar=this.add.graphics()}createAnimations(){this.cache.json.get("animations_json").forEach(e=>{let t=e.frames?this.anims.generateFrameNumbers(e.assetKey,{frames:e.frames}):this.anims.generateFrameNumbers(e.assetKey);this.anims.create({key:e.key,frames:t,frameRate:e.frameRate,repeat:e.repeat,yoyo:-1===e.repeat})})}constructor(){super({key:"PreloadScene"}),this.updateLoadingBar=e=>{let{width:t,height:s}=this.cameras.main,i=.6*t;this.progressBar.clear().fillStyle(16777215,1).fillRect((t-i)/2,s/2-20,i*e,20)},this.onLoadComplete=()=>{this.loadingBar.destroy(),this.progressBar.destroy(),this.scene.start("MainMenu")}}}class eu extends o().Scene{init(e){this.currentLevel=e.level,this.levelBonus=1e3*e.lives}create(){this.add.rectangle(0,0,this.scale.width,this.scale.height,0).setOrigin(0),this.add.text(this.scale.width/2,this.scale.height/2-50,"STAGE COMPLETE",{fontSize:"48px",color:"#ffffff"}).setOrigin(.5).setDepth(11);let e=this.add.text(this.scale.width/2,this.scale.height/2+20,"LIFE BONUS",{fontSize:"32px",color:"#ffffff"}).setOrigin(.5).setAlpha(0).setDepth(11),t=this.add.text(this.scale.width/2,this.scale.height/2+60,this.levelBonus.toString(),{fontSize:"40px",color:"#ffcc00"}).setOrigin(.5).setAlpha(0).setDepth(11);this.tweens.add({targets:e,alpha:1,duration:1e3,delay:1e3,onComplete:()=>{this.tweens.add({targets:t,alpha:1,duration:800,onComplete:()=>{l.emit(r.ADD_BONUS_SCORE,this.levelBonus),this.time.delayedCall(5e3,()=>{this.scene.stop(),this.scene.get("GameScene").events.emit("level-transition",this.currentLevel)})}})}})}constructor(){super({key:"LevelComplete"}),this.levelBonus=0,this.currentLevel=0}}class ed extends o().Scene{init(e){this.finalScore=e.score,this.bonusScore=1e3*(e.lives||0)}create(){this.overlay=this.add.rectangle(0,0,this.scale.width,this.scale.height,0,.5).setOrigin(0).setDepth(0),this.currentDisplayGroup=this.add.group(),this.showBonusScreen(),l.emit("current-scene-ready",this)}showBonusScreen(){this.clearCurrentDisplay();let e=this.add.text(this.scale.width/2,150,"GAME COMPLETE",{fontFamily:"Arial",fontSize:"48px",color:"#ffcc00",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(1),t=this.add.text(this.scale.width/2,300,"",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1),s=this.add.text(this.scale.width/2,400,"",{fontFamily:"Arial",fontSize:"36px",color:"#ffcc00",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setAlpha(0).setDepth(1);this.currentDisplayGroup.addMultiple([e,t,s]),this.tweens.addCounter({from:0,to:this.bonusScore,duration:2e3,onUpdate:e=>{let s=Math.floor(e.getValue());t.setText("LIFE BONUS: ".concat(s))},onComplete:()=>{this.finalScore+=this.bonusScore,s.setText("FINAL SCORE: ".concat(this.finalScore)).setAlpha(1),this.time.delayedCall(3e3,()=>{this.showCredits()})}})}showCredits(){this.clearCurrentDisplay(),l.emit(r.CLEANUP_GAME),this.scene.stop("GameScene");let e=150,t=[];["GAME CREATED BY","Acaride","","SPECIAL THANKS TO","Phaser 3 Framework","OpenGameArt.org","Kenney.nl","Freesound.org"].forEach(s=>{let i=this.add.text(this.scale.width/2,e,s,{fontFamily:"Arial",fontSize:s.includes("GAME")?"32px":"24px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1);t.push(i),e+=s?50:30}),this.currentDisplayGroup.addMultiple(t),this.time.delayedCall(6e3,()=>{this.showFinalMenu()})}showFinalMenu(){this.clearCurrentDisplay();let e=this.add.text(this.scale.width/2,150,"GAME CLEARED",{fontFamily:"Arial",fontSize:"48px",color:"#ffcc00",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(1),t=this.add.text(this.scale.width/2,230,"FINAL SCORE: ".concat(this.finalScore),{fontFamily:"Arial",fontSize:"36px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1),s=this.createMenuItem(350,"SAVE RESULT",()=>{b.isScoreInTop(this.finalScore)?this.scene.launch("InputScene",{score:this.finalScore,level:"All"}):this.showMessage("Score too low for top 10")}),i=this.createMenuItem(450,"MAIN MENU",()=>{this.scene.start("MainMenu")});this.menuItems=[s,i],this.currentDisplayGroup.addMultiple([e,t,s,i]),this.setupInput(),this.selectMenuItem(0)}createMenuItem(e,t,s){let i=this.add.text(this.scale.width/2,e,t,{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive().setDepth(1);return i.on("pointerover",()=>{this.selectedItemIndex=this.menuItems.indexOf(i),this.selectMenuItem(this.selectedItemIndex)}),i.on("pointerout",()=>{i.setColor("#ffffff")}),i.on("pointerdown",s),i}showMessage(e){let t=this.children.getByName("statusMessage");t&&t.destroy();let s=this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,e,{fontFamily:"Arial",fontSize:"28px",color:"#ff0000",backgroundColor:"#333333",padding:{left:20,right:20,top:10,bottom:10},stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(100).setName("statusMessage");s.setAlpha(0),this.tweens.add({targets:s,alpha:1,duration:300,ease:"Linear"}),this.time.delayedCall(2e3,()=>{this.tweens.add({targets:s,alpha:0,duration:500,ease:"Linear",onComplete:()=>s.destroy()})})}clearCurrentDisplay(){this.currentDisplayGroup.clear(!0,!0),this.menuItems=[],this.menuInput&&this.menuInput.cleanup(),this.input.off("pointermove")}setupInput(){this.menuInput=new ea(this),this.input.on("pointermove",e=>{if(!e.isDown)return;let t=this.menuItems.find(t=>t.getBounds().contains(e.x,e.y));t&&(this.selectedItemIndex=this.menuItems.indexOf(t),this.selectMenuItem(this.selectedItemIndex),t.emit("pointerdown"))})}update(e){!this.menuInput||this.isInputSceneActive()||(this.menuInput.update(),this.handleNavigation(e),this.handleSelection())}isInputSceneActive(){return this.scene.isActive("InputScene")}handleNavigation(e){!(e-this.lastInputTime<this.inputDelay)&&(this.menuInput.downIsDown?(this.changeSelectedItem(1),this.lastInputTime=e):this.menuInput.upIsDown&&(this.changeSelectedItem(-1),this.lastInputTime=e))}handleSelection(){this.menuInput.primaryActionIsDown&&this.menuItems[this.selectedItemIndex].emit("pointerdown")}changeSelectedItem(e){this.selectedItemIndex=(this.selectedItemIndex+e+this.menuItems.length)%this.menuItems.length,this.selectMenuItem(this.selectedItemIndex)}selectMenuItem(e){this.menuItems.forEach((t,s)=>{t.setColor(s===e?"#ff0":"#fff"),t.setScale(s===e?1.1:1)})}shutdown(){let e=this.children.getByName("statusMessage");e&&e.destroy(),this.clearCurrentDisplay(),this.overlay&&this.overlay.destroy()}constructor(){super({key:"Victory"}),this.menuItems=[],this.selectedItemIndex=0,this.lastInputTime=0,this.inputDelay=200,this.finalScore=0,this.bonusScore=0}}class ep extends Phaser.Scene{create(){this.events.once("shutdown",this.shutdown,this),this.currentSettings=b.loadSettings(),this.add.rectangle(0,0,50,50,0).setOrigin(0).setDepth(1e3),this.createConnectionStatus(),this.createBackground(),this.createTitle(),this.createSettingsMenu(),this.setupInput(),this.selectMenuItem(0),l.emit("current-scene-ready",this)}createAuthDisplay(){let e=localStorage.getItem("authToken"),t=localStorage.getItem("userId"),s=localStorage.getItem("username");e&&t&&s&&(er.initialize(e,t,s),er.enableSync()),this.authDisplayGroup&&this.authDisplayGroup.destroy(!0),this.authDisplayGroup=this.add.container(0,20).setDepth(1001);let i=!!(e&&t);if(this.authDisplayText=this.add.text(0,0,i&&s?s:"Login/Register",{fontFamily:"Arial",fontSize:"20px",color:"#ffffff",backgroundColor:i?void 0:"#0000ff",padding:{x:5,y:2}}).setOrigin(0,0),i){this.logoutButton=this.add.text(0,0,"[Logout]",{fontFamily:"Arial",fontSize:"18px",color:"#ff4444",backgroundColor:"#000000",padding:{x:5,y:2}}).setOrigin(0,0).setInteractive({useHandCursor:!0}),this.logoutButton.on("pointerdown",()=>this.handleLogout()),this.authDisplayGroup.add(this.authDisplayText),this.authDisplayGroup.add(this.logoutButton);let e=this.authDisplayText.width+10+this.logoutButton.width;this.authDisplayText.x=0,this.logoutButton.x=this.authDisplayText.width+10,this.authDisplayGroup.x=this.cameras.main.width-e-20}else this.authDisplayText.setInteractive({useHandCursor:!0}),this.authDisplayText.once("pointerdown",()=>this.scene.launch("AuthScene")),this.authDisplayGroup.add(this.authDisplayText),this.authDisplayGroup.x=this.cameras.main.width-this.authDisplayText.width-20}createConnectionStatus(){this.connectionStatusText=this.add.text(20,20,"Checking server status...",{fontFamily:"Arial",fontSize:"20px",color:"#ffff00"}).setOrigin(0).setDepth(1001);let e=async()=>{this.connectionStatusText.setText("Checking connection..."),this.connectionStatusText.setColor("#ffff00"),await er.isDbConnected()?(this.connectionStatusText.setText("Server: Connected ✅"),this.connectionStatusText.setColor("#00ff00"),this.createAuthDisplay()):(this.connectionStatusText.setText("Server: Local Mode ⚠️"),this.connectionStatusText.setColor("#ffff00"),this.authDisplayGroup&&this.authDisplayGroup.destroy(!0))};e();let t=setInterval(e,5e3);this.connectionStatusText.setInteractive(),this.connectionStatusText.on("pointerdown",async()=>{this.connectionStatusText.setText("Checking..."),this.connectionStatusText.setColor("#ffff00"),await e()}),this.events.once("shutdown",()=>clearInterval(t))}handleLogout(){er.disableSync(),localStorage.removeItem("authToken"),localStorage.removeItem("userId"),this.isSyncing=!1,localStorage.setItem("isSyncing","false"),this.updateSettingsDisplay(),this.createAuthDisplay()}async syncData(){if(this.isSyncing){if(!await er.checkConnection()){this.isSyncing=!1,localStorage.setItem("isSyncing","false"),er.disableSync(),this.updateSettingsDisplay();return}try{let e=await er.loadSettings();e&&(this.currentSettings={...this.currentSettings,...e},b.saveSettings(this.currentSettings),await er.saveSettings(this.currentSettings),this.updateSettingsDisplay());let t=await er.loadHighScores(),s=b.loadHighScores(),i=[];if(t&&t.length>0)for(let e of(i=this.mergeAndSortScores(s,t),await er.clearHighScores(),i))await er.addHighScore(e);else for(let e of(i=s,s))await er.addHighScore(e);b.saveHighScores(i),console.log("Synchronization completed successfully")}catch(e){console.error("Synchronization failed:",e),this.isSyncing=!1,localStorage.setItem("isSyncing","false"),er.disableSync(),this.updateSettingsDisplay()}}}mergeAndSortScores(e,t){let s=[...e,...t],i=new Map;for(let e of s){let t="".concat(e.name,"_").concat(e.score,"_").concat(e.level);i.has(t)||i.set(t,e)}return Array.from(i.values()).sort((e,t)=>t.score-e.score).slice(0,10)}updateSettingsDisplay(){this.settingItems[0].setText("Music: [".concat(this.getVolumeBars(this.currentSettings.musicVolume),"]")),this.settingItems[1].setText("SFX: [".concat(this.getVolumeBars(this.currentSettings.sfxVolume),"]")),this.settingItems[2].setText("Show FPS: ".concat(this.currentSettings.showFPS?"ON":"OFF")),this.settingItems[3].setText("Weapon: ".concat(this.currentSettings.weaponType.toUpperCase())),this.settingItems[4].setText("Sync: ".concat(this.isSyncing?"ON":"OFF"))}applySettings(){b.saveSettings(this.currentSettings),this.isSyncing&&er.saveSettings(this.currentSettings).then(e=>{e||(this.isSyncing=!1,localStorage.setItem("isSyncing","false"),er.disableSync(),this.updateSettingsDisplay())}).catch(e=>{console.error("Failed to sync settings:",e),this.isSyncing=!1,localStorage.setItem("isSyncing","false"),er.disableSync(),this.updateSettingsDisplay()}),l.emit(r.SETTINGS_CHANGED,this.currentSettings)}createBackground(){this.add.image(0,0,"background").setOrigin(0).setScale(1.25)}createTitle(){this.add.text(this.cameras.main.width/2,100,"OPTIONS",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff",stroke:"#000000",strokeThickness:4}).setOrigin(.5)}getVolumeBars(e){return"■".repeat(Math.floor(10*e))+"□".repeat(10-Math.floor(10*e))}createSettingsMenu(){let e=this.cameras.main.width/2,t=200,s=this.add.text(e,t,"Music: [".concat(this.getVolumeBars(this.currentSettings.musicVolume),"]"),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);this.settingItems.push(s),t+=60;let i=this.add.text(e,t,"SFX: [".concat(this.getVolumeBars(this.currentSettings.sfxVolume),"]"),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);this.settingItems.push(i),t+=60;let n=this.add.text(e,t,"Show FPS: ".concat(this.currentSettings.showFPS?"ON":"OFF"),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);this.settingItems.push(n),t+=60;let a=this.add.text(e,t,"Weapon: ".concat(this.currentSettings.weaponType.toUpperCase()),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);this.settingItems.push(a),t+=60,this.syncToggleText=this.add.text(e,t,"Sync: ".concat(this.isSyncing?"ON":"OFF"),{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5),this.settingItems.push(this.syncToggleText),t+=100;let o=this.add.text(e,t,"RESET TO DEFAULTS",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5).setInteractive();this.menuItems.push(o),o.on("pointerover",()=>{this.selectedItemIndex=this.settingItems.length,this.selectMenuItem(this.selectedItemIndex)}),o.on("pointerout",()=>{o.setColor("#ffffff")}),o.on("pointerdown",()=>this.resetToDefaults()),t+=60;let r=this.add.text(e,t,"BACK TO MENU",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5).setInteractive();this.menuItems.push(r),r.on("pointerover",()=>{this.selectedItemIndex=this.settingItems.length+1,this.selectMenuItem(this.selectedItemIndex)}),r.on("pointerout",()=>{r.setColor("#ffffff")}),r.on("pointerdown",()=>this.returnToMenu())}resetToDefaults(){this.currentSettings=b.getDefaultConfig(),this.settingItems[0].setText("Music: [".concat(this.getVolumeBars(this.currentSettings.musicVolume),"]")),this.settingItems[1].setText("SFX: [".concat(this.getVolumeBars(this.currentSettings.sfxVolume),"]")),this.settingItems[2].setText("Show FPS: ".concat(this.currentSettings.showFPS?"ON":"OFF")),this.settingItems[3].setText("Weapon: ".concat(this.currentSettings.weaponType.toUpperCase())),this.applySettings()}setupInput(){this.menuInput=new ea(this)}update(e){if(this.menuInput&&(this.menuInput.update(),!(e-this.lastInputTime<this.inputDelay))){if(this.menuInput.downIsDown)this.changeSelectedItem(1),this.lastInputTime=e;else if(this.menuInput.upIsDown)this.changeSelectedItem(-1),this.lastInputTime=e;else if(this.menuInput.rightIsDown&&this.selectedItemIndex<this.settingItems.length)this.adjustSetting(1),this.lastInputTime=e;else if(this.menuInput.leftIsDown&&this.selectedItemIndex<this.settingItems.length)this.adjustSetting(-1),this.lastInputTime=e;else if(this.menuInput.primaryActionIsDown){let e=this.settingItems.length,t=this.settingItems.length+1;this.selectedItemIndex===e?this.resetToDefaults():this.selectedItemIndex===t&&this.returnToMenu()}this.handleSecondaryAction()}}adjustSetting(e){let t={...this.currentSettings};switch(this.selectedItemIndex){case 0:this.currentSettings.musicVolume=Phaser.Math.Clamp(this.currentSettings.musicVolume+.1*e,0,1),this.settingItems[0].setText("Music: [".concat(this.getVolumeBars(this.currentSettings.musicVolume),"]"));break;case 1:this.currentSettings.sfxVolume=Phaser.Math.Clamp(this.currentSettings.sfxVolume+.1*e,0,1),this.settingItems[1].setText("SFX: [".concat(this.getVolumeBars(this.currentSettings.sfxVolume),"]"));break;case 2:this.currentSettings.showFPS=!this.currentSettings.showFPS,this.settingItems[2].setText("Show FPS: ".concat(this.currentSettings.showFPS?"ON":"OFF"));break;case 3:let s=["wide","laser","rockets"],i=(s.indexOf(this.currentSettings.weaponType)+e+s.length)%s.length;this.currentSettings.weaponType=s[i],this.settingItems[3].setText("Weapon: ".concat(this.currentSettings.weaponType.toUpperCase()));break;case 4:if(!er.isLoggedIn()){alert("Please login to enable sync");return}this.isSyncing=!this.isSyncing,this.isSyncing?(er.enableSync(),this.syncData().then(()=>{this.isSyncing=!0,localStorage.setItem("isSyncing","true"),this.settingItems[4].setText("Sync: ON")}).catch(e=>{console.error("Failed to enable sync:",e),er.disableSync(),this.isSyncing=!1,localStorage.setItem("isSyncing","false"),this.settingItems[4].setText("Sync: OFF"),alert("Failed to enable synchronization. Please try again later.")})):(er.disableSync(),this.isSyncing=!1,localStorage.setItem("isSyncing","false"),this.settingItems[4].setText("Sync: OFF"));return}this.updateSettingsDisplay(),this.applySettings(),this.isSyncing&&(t.musicVolume!==this.currentSettings.musicVolume||t.sfxVolume!==this.currentSettings.sfxVolume)&&er.saveSettings(this.currentSettings).catch(e=>{console.error("Failed to sync audio settings:",e)})}handleSecondaryAction(){this.menuInput.secondaryActionIsDown&&this.returnToMenu()}returnToMenu(){this.applySettings(),this.scene.start("MainMenu")}changeSelectedItem(e){let t=this.settingItems.length+2;this.selectedItemIndex=(this.selectedItemIndex+e+t)%t,this.selectMenuItem(this.selectedItemIndex)}selectMenuItem(e){this.settingItems.forEach((t,s)=>{t.setColor(s===e?"#ff0":"#ffffff")}),this.menuItems.forEach((t,s)=>{let i=this.settingItems.length+s;t.setColor(e===i?"#ff0":"#ffffff")})}shutdown(){var e,t,s,i,n;this.menuInput.cleanup(),this.settingItems.forEach(e=>e.destroy()),this.menuItems.forEach(e=>e.destroy()),this.settingItems=[],this.menuItems=[],null===(e=this.authDisplayGroup)||void 0===e||e.destroy(!0),null===(t=this.authStatusText)||void 0===t||t.destroy(),null===(s=this.syncToggleText)||void 0===s||s.destroy(),null===(i=this.connectionStatusText)||void 0===i||i.destroy(),null===(n=this.logoutButton)||void 0===n||n.destroy(),this.input.off("pointermove"),this.selectedItemIndex=0}constructor(){super("OptionsScene"),this.menuItems=[],this.settingItems=[],this.selectedItemIndex=0,this.lastInputTime=0,this.inputDelay=200,this.isSyncing="true"===localStorage.getItem("isSyncing")}}class em extends o().Scene{create(){let e=b.loadHighScores();this.add.rectangle(0,0,50,50,0).setOrigin(0).setDepth(1e3),this.createBackground(),this.createRecordsDisplay(e),this.createButtons(),this.setupInput(),l.emit("current-scene-ready",this)}createBackground(){this.add.image(0,0,"background").setOrigin(0).setScale(1.25)}createRecordsDisplay(e){this.clearRecordsElements();let t=this.add.text(this.cameras.main.width/2,30,"HIGH SCORES",{fontFamily:"Arial",fontSize:"28px",color:"#ffcc00",stroke:"#000000",strokeThickness:2}).setOrigin(.5),s=this.add.text(20,70,"RANK",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),i=this.add.text(80,70,"NAME",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(220,70,"SCORE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),a=this.add.text(360,70,"LVL",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(400,70,"DATE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"});this.recordsElements.push(t,s,i,n,a,o),e.forEach((e,t)=>{let s=100+30*t,i=this.add.text(20,s,"".concat(t+1,"."),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(80,s,e.name,{fontFamily:"Arial",fontSize:"16px",color:"#ffff00"}),a=this.add.text(220,s,e.score.toString(),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(360,s,"number"==typeof e.level?e.level.toString():"All",{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"}),r=new Date(e.date),h=this.add.text(400,s,"".concat(r.getDate(),".").concat(r.getMonth()+1,".").concat(r.getFullYear()),{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"});this.recordsElements.push(i,n,a,o,h)})}createButtons(){this.buttons=[],this.backButton=this.add.text(this.cameras.main.width/2-150,550,"BACK",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive(),this.resetButton=this.add.text(this.cameras.main.width/2+100,550,"RESET SCORES",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive(),this.buttons.push(this.backButton,this.resetButton),this.backButton.on("pointerover",()=>{this.selectedButtonIndex=0,this.updateButtonSelection()}),this.backButton.on("pointerout",()=>{this.updateButtonSelection()}),this.backButton.on("pointerdown",()=>{this.scene.start("MainMenu")}),this.resetButton.on("pointerover",()=>{this.selectedButtonIndex=1,this.updateButtonSelection()}),this.resetButton.on("pointerout",()=>{this.updateButtonSelection()}),this.resetButton.on("pointerdown",()=>{this.resetHighScores()}),this.updateButtonSelection()}async resetHighScores(){if(b.saveHighScores(b.loadHighScores().map((e,t)=>({name:"NoEntry",score:(10-t)*1e3,level:10-t>=3?"All":10-t,date:new Date(Date.now()-864e5*t).toISOString()}))),er.isSyncEnabled())try{for(let e of(await er.clearHighScores(),b.loadHighScores()))await er.addHighScore(e)}catch(e){console.error("Ошибка при очистке серверных рекордов",e);return}this.createRecordsDisplay(b.loadHighScores()),this.showMessage("Scores reset to default")}showMessage(e){let t=this.add.text(this.cameras.main.width/2,500,e,{fontFamily:"Arial",fontSize:"24px",color:"#00ff00"}).setOrigin(.5);this.time.delayedCall(2e3,()=>{t.destroy()})}updateButtonSelection(){this.buttons.forEach((e,t)=>{e.setColor(t===this.selectedButtonIndex?"#ff0":"#fff"),e.setScale(t===this.selectedButtonIndex?1.1:1)})}setupInput(){this.menuInput=new ea(this),this.backButton.on("pointerover",()=>{this.selectedButtonIndex=0,this.updateButtonSelection()}),this.resetButton.on("pointerover",()=>{this.selectedButtonIndex=1,this.updateButtonSelection()})}clearRecordsElements(){this.recordsElements.forEach(e=>{(null==e?void 0:e.destroy)&&e.destroy()}),this.recordsElements=[]}update(e){this.menuInput&&(this.menuInput.update(),e-this.lastInputTime>=this.inputDelay&&(this.menuInput.leftIsDown?(this.selectedButtonIndex=(this.selectedButtonIndex-1+this.buttons.length)%this.buttons.length,this.updateButtonSelection(),this.lastInputTime=e):this.menuInput.rightIsDown&&(this.selectedButtonIndex=(this.selectedButtonIndex+1)%this.buttons.length,this.updateButtonSelection(),this.lastInputTime=e)),this.menuInput.primaryActionIsDown&&this.buttons[this.selectedButtonIndex].emit("pointerdown"),this.menuInput.secondaryActionIsDown&&this.scene.start("MainMenu"))}shutdown(){var e;this.menuInput.cleanup(),this.clearRecordsElements(),null===(e=this.input.keyboard)||void 0===e||e.off("keydown")}constructor(){super("RecordsScene"),this.recordsElements=[],this.selectedButtonIndex=0,this.buttons=[],this.lastInputTime=0,this.inputDelay=200}}class ef extends o().Scene{init(e){this.score=e.score,this.level=e.level}create(){this.background=this.add.rectangle(0,0,this.cameras.main.width,this.cameras.main.height,0,.8).setOrigin(0).setDepth(0),this.createInputUI()}createInputUI(){var e;this.clearInputElements(),this.inputActive=!0,this.showingRecords=!1;let t=this.add.text(this.cameras.main.width/2,150,"NEW HIGH SCORE!",{fontFamily:"Arial",fontSize:"36px",color:"#ffcc00",stroke:"#000000",strokeThickness:2}).setOrigin(.5),s=this.add.text(this.cameras.main.width/2,200,"SCORE: ".concat(this.score),{fontFamily:"Arial",fontSize:"28px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5),i=this.add.text(this.cameras.main.width/2,280,"ENTER YOUR NAME:",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff"}).setOrigin(.5);this.inputText=this.add.text(this.cameras.main.width/2,350,"",{fontFamily:"Arial",fontSize:"32px",color:"#ffff00",backgroundColor:"#333333",padding:{left:10,right:10,top:5,bottom:5}}).setOrigin(.5);let n=this.add.text(this.cameras.main.width/2,400,"(MAX 9 CHARACTERS, NO SPACES)",{fontFamily:"Arial",fontSize:"24px",color:"#aaaaaa"}).setOrigin(.5),a=this.add.text(this.cameras.main.width/2,440,"ESC TO CANCEL",{fontFamily:"Arial",fontSize:"24px",color:"#ff5555"}).setOrigin(.5);this.inputElements=[t,s,i,this.inputText,n,a],null===(e=this.input.keyboard)||void 0===e||e.on("keydown",this.handleKeyInput,this)}handleKeyInput(e){if(!this.inputActive)return;if("Escape"===e.key||this.showingRecords){this.cleanupAndClose();return}let t=["Enter","Backspace","Delete","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","Tab"].includes(e.key),s=/^[a-zA-Z]$/.test(e.key),i=/^[0-9]$/.test(e.key);if("Enter"===e.key)this.saveScore();else if("Backspace"===e.key)this.inputText.text=this.inputText.text.slice(0,-1);else if((s||i||t)&&this.inputText.text.length<9){let t=s?e.key.toUpperCase():e.key;this.inputText.text+=t}}async saveScore(){let e={name:(this.inputText.text||"PLAYER").substring(0,9).replace(/\s/g,""),score:this.score,level:this.level},t=b.addHighScore(e);if(er.isSyncEnabled())try{let s=await er.addHighScore(e);if(s){let e=this.mergeAndSortScores(t,s);for(let t of(b.saveHighScores(e),await er.clearHighScores(),e))await er.addHighScore(t)}}catch(e){console.error("Failed to sync high score:",e)}this.inputActive=!1,this.clearInputElements(),this.showHighScores()}mergeAndSortScores(e,t){let s=[...e,...t],i=new Map;for(let e of s){let t="".concat(e.name,"_").concat(e.score,"_").concat(e.level);i.has(t)||i.set(t,e)}return Array.from(i.values()).sort((e,t)=>t.score-e.score).slice(0,10)}showHighScores(){var e;this.clearRecordsElements(),this.showingRecords=!0;let t=b.loadHighScores(),s=this.add.text(this.cameras.main.width/2,30,"HIGH SCORES",{fontFamily:"Arial",fontSize:"28px",color:"#ffcc00",stroke:"#000000",strokeThickness:2}).setOrigin(.5),i=this.add.text(20,70,"RANK",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(80,70,"NAME",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),a=this.add.text(220,70,"SCORE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(360,70,"LVL",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),r=this.add.text(400,70,"DATE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"});this.recordsElements.push(s,i,n,a,o,r),t.forEach((e,t)=>{let s=100+30*t,i=this.add.text(20,s,"".concat(t+1,"."),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(80,s,e.name,{fontFamily:"Arial",fontSize:"16px",color:"#ffff00"}),a=this.add.text(220,s,e.score.toString(),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(360,s,"number"==typeof e.level?e.level.toString():"All",{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"}),r=new Date(e.date),h=this.add.text(400,s,"".concat(r.getDate(),".").concat(r.getMonth()+1,".").concat(r.getFullYear()),{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"});this.recordsElements.push(i,n,a,o,h)});let h=this.add.text(this.cameras.main.width/2,450,"PRESS ANY KEY TO CONTINUE",{fontFamily:"Arial",fontSize:"20px",color:"#00ff00",stroke:"#000000",strokeThickness:2}).setOrigin(.5);this.recordsElements.push(h),null===(e=this.input.keyboard)||void 0===e||e.once("keydown",()=>{this.cleanupAndClose()})}clearInputElements(){var e;this.inputElements.forEach(e=>{(null==e?void 0:e.destroy)&&e.destroy()}),this.inputElements=[],null===(e=this.input.keyboard)||void 0===e||e.off("keydown",this.handleKeyInput)}clearRecordsElements(){this.recordsElements.forEach(e=>{(null==e?void 0:e.destroy)&&e.destroy()}),this.recordsElements=[]}cleanupAndClose(){var e,t;this.clearInputElements(),this.clearRecordsElements(),(null===(e=this.background)||void 0===e?void 0:e.destroy)&&this.background.destroy(),null===(t=this.input.keyboard)||void 0===t||t.off("keydown"),this.scene.stop()}shutdown(){this.cleanupAndClose()}constructor(){super({key:"InputScene"}),this.inputActive=!0,this.inputElements=[],this.recordsElements=[],this.showingRecords=!1}}class eg extends Phaser.Scene{create(){this.cameras.main.setBackgroundColor("#000000"),this.createLoginForm(),this.createRegisterForm(),this.showCurrentForm(),this.loginForm.setOrigin(.5),this.registerForm.setOrigin(.5),this.menuItems=[];let e=this.cameras.main.width/2,t=this.cameras.main.height-120,s=this.createMenuItem(e,t,"login"===this.currentForm?"Switch to Register":"Switch to Login",()=>{this.currentForm="login"===this.currentForm?"register":"login",s.setText("login"===this.currentForm?"Switch to Register":"Switch to Login"),this.showCurrentForm()});this.menuItems.push(s);let i=this.createMenuItem(e,t+50,"Back",()=>this.scene.start("OptionsScene"));this.menuItems.push(i)}createMenuItem(e,t,s,i){let n=this.add.text(e,t,s,{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive();return n.on("pointerover",()=>{n.setColor("#ffff00"),n.setScale(1.1)}),n.on("pointerout",()=>{n.setColor("#ffffff"),n.setScale(1)}),n.on("pointerdown",i),n}showCurrentForm(){this.loginForm.setVisible("login"===this.currentForm),this.registerForm.setVisible("register"===this.currentForm)}createLoginForm(){this.loginForm=this.add.dom(this.cameras.main.width/2,this.cameras.main.height/2-50).createFromCache("loginForm"),this.loginForm.addListener("click"),this.loginForm.on("click",e=>{if("loginButton"===e.target.name){let e=this.loginForm.getChildByName("username").value,t=this.loginForm.getChildByName("password").value;this.handleLogin(e,t)}})}createRegisterForm(){this.registerForm=this.add.dom(this.cameras.main.width/2,this.cameras.main.height/2-50).createFromCache("registerForm"),this.registerForm.addListener("click"),this.registerForm.on("click",e=>{if("registerButton"===e.target.name){let e=this.registerForm.getChildByName("username").value,t=this.registerForm.getChildByName("password").value;if(t!==this.registerForm.getChildByName("confirmPassword").value){alert("Passwords do not match!");return}this.handleRegister(e,t)}})}async handleLogin(e,t){try{let s=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),i=await s.json();s.ok?(er.initialize(i.token,i.userId,i.username),localStorage.setItem("authToken",i.token),localStorage.setItem("userId",i.userId),localStorage.setItem("username",i.username),alert("Login successful!"),this.scene.start("OptionsScene")):alert(i.message||"Login failed")}catch(e){console.error("Login error:",e),alert("An error occurred during login")}}async handleRegister(e,t){try{let s=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})}),i=await s.json();s.ok?(alert("Registration successful! Please login."),this.currentForm="login",this.showCurrentForm()):alert(i.message||"Registration failed")}catch(e){console.error("Registration error:",e),alert("An error occurred during registration")}}constructor(){super("AuthScene"),this.currentForm="login",this.menuItems=[]}}class ey extends o().Scene{create(){this.createBackground(),this.createLoadingAnimation(),this.add.rectangle(0,0,50,50,0).setOrigin(0).setDepth(1e3),this.loadRecords()}createLoadingAnimation(){let e=this.cameras.main.width/2,t=this.cameras.main.height/2;this.loadingText=this.add.text(e,t,"Loading",{fontFamily:"Arial",fontSize:"48px",color:"#ffffff"}).setOrigin(.5),this.loadingTimer=this.time.addEvent({delay:100,loop:!0,callback:()=>{this.loadingDotCount=(this.loadingDotCount+1)%4,this.loadingText.setText("Loading"+".".repeat(this.loadingDotCount))}})}async loadRecords(){let e=await er.loadGlobalLeaderboard()||[];this.loadingTimer&&this.loadingTimer.remove(!1),this.loadingText&&this.loadingText.destroy(),this.createRecordsDisplay(e),this.createButtons(),this.setupInput(),this.events.emit("current-scene-ready",this)}createBackground(){this.add.image(0,0,"background").setOrigin(0).setScale(1.25)}createRecordsDisplay(e){this.clearRecordsElements();let t=this.add.text(this.cameras.main.width/2,30,"GLOBAL LEADERBOARD",{fontFamily:"Arial",fontSize:"28px",color:"#00ccff",stroke:"#000000",strokeThickness:2}).setOrigin(.5),s=this.add.text(20,70,"RANK",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),i=this.add.text(80,70,"NAME",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(220,70,"SCORE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),a=this.add.text(360,70,"LVL",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(400,70,"DATE",{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"});this.recordsElements.push(t,s,i,n,a,o),e.forEach((e,t)=>{let s=100+30*t,i=this.add.text(20,s,"".concat(t+1,"."),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),n=this.add.text(80,s,e.name,{fontFamily:"Arial",fontSize:"16px",color:"#ffff00"}),a=this.add.text(220,s,e.score.toString(),{fontFamily:"Arial",fontSize:"16px",color:"#ffffff"}),o=this.add.text(360,s,"number"==typeof e.level?e.level.toString():"All",{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"}),r=new Date(e.date),h=this.add.text(400,s,"".concat(r.getDate(),".").concat(r.getMonth()+1,".").concat(r.getFullYear()),{fontFamily:"Arial",fontSize:"16px",color:"#aaaaaa"});this.recordsElements.push(i,n,a,o,h)})}createButtons(){this.buttons=[],this.backButton=this.add.text(this.cameras.main.width/2,550,"BACK",{fontFamily:"Arial",fontSize:"32px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setInteractive(),this.buttons.push(this.backButton),this.backButton.on("pointerover",()=>{this.selectedButtonIndex=0,this.updateButtonSelection()}),this.backButton.on("pointerdown",()=>{this.scene.start("MainMenu")}),this.updateButtonSelection()}updateButtonSelection(){this.buttons.forEach((e,t)=>{e.setColor(t===this.selectedButtonIndex?"#ff0":"#fff"),e.setScale(t===this.selectedButtonIndex?1.1:1)})}setupInput(){this.menuInput=new ea(this),this.backButton.on("pointerover",()=>{this.selectedButtonIndex=0,this.updateButtonSelection()})}clearRecordsElements(){this.recordsElements.forEach(e=>{(null==e?void 0:e.destroy)&&e.destroy()}),this.recordsElements=[]}update(e){this.menuInput&&(this.menuInput.update(),e-this.lastInputTime>=this.inputDelay&&(this.menuInput.leftIsDown?(this.selectedButtonIndex=(this.selectedButtonIndex-1+this.buttons.length)%this.buttons.length,this.updateButtonSelection(),this.lastInputTime=e):this.menuInput.rightIsDown&&(this.selectedButtonIndex=(this.selectedButtonIndex+1)%this.buttons.length,this.updateButtonSelection(),this.lastInputTime=e)),this.menuInput.primaryActionIsDown&&this.buttons[this.selectedButtonIndex].emit("pointerdown"),this.menuInput.secondaryActionIsDown&&this.scene.start("MainMenu"))}shutdown(){var e;this.menuInput.cleanup(),this.clearRecordsElements(),null===(e=this.input.keyboard)||void 0===e||e.off("keydown"),this.loadingTimer&&this.loadingTimer.remove(!1)}constructor(){super("LeaderboardScene"),this.loadingDotCount=0,this.recordsElements=[],this.buttons=[],this.selectedButtonIndex=0,this.lastInputTime=0,this.inputDelay=200}}let ev={type:a.AUTO,width:480,height:640,parent:"game-container",roundPixels:!0,pixelArt:!0,scale:{mode:Phaser.Scale.HEIGHT_CONTROLS_WIDTH,autoCenter:Phaser.Scale.CENTER_BOTH},fps:{target:60,forceSetTimeOut:!0,smoothStep:!1},backgroundColor:"#000000",physics:{default:"arcade",arcade:{gravity:{y:0,x:0},debug:!1}},scene:[u,ec,eh,en,el,eo,eu,ed,em,ep,ef,eg,ey],dom:{createContainer:!0}};var eS=e=>new a.Game({...ev,parent:e});let eI=(0,n.forwardRef)(function(e,t){let{currentActiveScene:s}=e,a=(0,n.useRef)(null);return(0,n.useLayoutEffect)(()=>(null===a.current&&(a.current=eS("game-container"),"function"==typeof t?t({game:a.current,scene:null}):t&&(t.current={game:a.current,scene:null})),()=>{a.current&&(a.current.destroy(!0),null!==a.current&&(a.current=null))}),[t]),(0,n.useEffect)(()=>(l.on("current-scene-ready",e=>{s&&"function"==typeof s&&s(e),"function"==typeof t?t({game:a.current,scene:e}):t&&(t.current={game:a.current,scene:e})}),()=>{l.removeListener("current-scene-ready")}),[s,t]),(0,i.jsx)("div",{id:"game-container"})});function ew(){let e=(0,n.useRef)(null);return(0,i.jsx)("div",{id:"app",children:(0,i.jsx)(eI,{ref:e})})}}}]);